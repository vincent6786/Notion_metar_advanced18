<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>METAR PLUS Pro</title>
    <meta name="apple-mobile-web-app-title" content="METAR GO">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/vincent6786/Notion_metar_advanced/main/app-icon.png">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/vincent6786/Notion_metar_advanced/main/app-icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        /* --- 1. CORE THEME & LAYOUT --- */
        :root {
            --bg: #000000; --card-bg: #1c1c1e; --text: #ffffff; --sub-text: #8e8e93;
            --border: #38383a; --accent: #0a84ff; 
            --danger: #ff453a; --warn: #ff9f0a; --success: #32d74b;
            --mvfr: #0a84ff; --lifr: #bf5af2;
            --sky-bg: #131d2e;
            --strip-bg: #3a3a3c;
        }
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, sans-serif;
            background-color: var(--bg); color: var(--text);
            margin: 0; padding: 12px; font-size: 14px; line-height: 1.4;
            display: flex; flex-direction: column; gap: 12px;
            padding-bottom: max(20px, env(safe-area-inset-bottom)); 
            padding-top: max(12px, env(safe-area-inset-top));
            overscroll-behavior-y: none;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- 2. ANIMATIONS --- */
        @keyframes slideUpFade {
            0% { opacity: 0; transform: translateY(20px) scale(0.98); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        .view-section.active > * { animation: slideUpFade 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) both; }

        /* --- 3. LIQUID GLASS MODE (iOS Home Screen Only) --- */
        @media all and (display-mode: standalone) {
            body {
                background: linear-gradient(160deg, #1a1a2e 0%, #000000 100%);
                background-attachment: fixed;
            }
            .metar-card, .info-card, .freq-card, .search-box, .wind-vis-container, .taf-detail-card, .fr-bar-container, .atc-btn, .nearby-btn, .tabs, .sky-section, .meteogram-container, .quick-chip {
                background: rgba(35, 35, 40, 0.65) !important;
                backdrop-filter: blur(25px);
                -webkit-backdrop-filter: blur(25px);
                border: 1px solid rgba(255, 255, 255, 0.08);
                box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            }
            .search-box { background: rgba(60, 60, 65, 0.5) !important; }
            .tabs {
                background: rgba(0, 0, 0, 0.3) !important;
                border-radius: 12px;
                margin-top: 4px;
                padding: 4px;
                border: 1px solid rgba(255,255,255,0.05);
            }
            .tab.active { color: #fff; text-shadow: 0 0 10px rgba(10, 132, 255, 0.8); }
        }

        /* --- 4. FEATURE: COCKPIT NIGHT MODE --- */
        body.cockpit-dark {
            --bg: #000000 !important; --card-bg: #000000 !important;
            --text: #ff3333 !important; --sub-text: #881111 !important;
            --border: #550000 !important; --accent: #ff0000 !important;
            --success: #ff0000 !important; --warn: #cc3300 !important;
            --danger: #ff0000 !important; --mvfr: #aa0000 !important;
            --lifr: #770000 !important; --sky-bg: #000000 !important;
            --strip-bg: #220000 !important;
        }
        body.cockpit-dark * {
            backdrop-filter: none !important; box-shadow: none !important;
            text-shadow: none !important; border-color: #440000 !important;
        }
        body.cockpit-dark .sky-section, body.cockpit-dark canvas, 
        body.cockpit-dark .icon-btn, body.cockpit-dark .fr-track-modern, 
        body.cockpit-dark .taf-sky-strip, body.cockpit-dark .meteogram-container, 
        body.cockpit-dark .quick-chip {
            filter: grayscale(100%) sepia(100%) saturate(1000%) hue-rotate(-50deg) contrast(1.5);
        }
        body.cockpit-dark .badge-cat { color: #000 !important; background: #ff0000 !important; font-weight: 900; }
        body.cockpit-dark .tab.active { border-bottom-color: #ff0000; color: #ff0000; }
        body.cockpit-dark input, body.cockpit-dark select { background: #110000 !important; color: #ff3333 !important; }
        
        /* NOTAM HIGHLIGHTER STYLES */
        .n-crit { color: #ff453a; font-weight: 800; background: rgba(255, 69, 58, 0.15); padding: 0 4px; border-radius: 3px; }
        .n-warn { color: #ff9f0a; font-weight: 700; }
        .n-bold { color: #ffffff; font-weight: 700; text-decoration: underline; text-decoration-color: #555; }
        body.cockpit-dark .n-crit { color: #ff0000; background: #330000; }
        body.cockpit-dark .n-warn { color: #cc3300; }
        body.cockpit-dark .n-bold { color: #ff3333; }

        /* --- 5. UI ELEMENTS --- */
        .top-bar { display: flex; align-items: center; gap: 8px; height: 40px; }
        .search-wrapper { flex-grow: 1; position: relative; display: flex; align-items: center; }
        .search-box {
            width: 100%; background: var(--card-bg); border-radius: 8px; 
            display: flex; align-items: center; border: 1px solid var(--border);
            padding-left: 8px; transition: border-color 0.2s;
        }
        .search-box:focus-within { border-color: var(--accent); }
        #icao {
            flex-grow: 1; background: transparent; border: none; color: inherit; 
            padding: 8px 4px; text-transform: uppercase; font-weight: 700; 
            font-size: 16px; outline: none; width: 100%;
        }
        .clear-btn { color: var(--sub-text); cursor: pointer; padding: 0 8px; font-size: 14px; display: none; }
        .icon-btn { 
            background: var(--card-bg); border: 1px solid var(--border); color: var(--accent); 
            width: 40px; height: 100%; border-radius: 8px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; text-decoration: none; font-size: 18px;
        }
        .badge { height: 100%; display: flex; align-items: center; justify-content: center; padding: 0 12px; border-radius: 8px; font-weight: 700; font-size: 15px; min-width: 60px; }
        .badge-time { background: var(--card-bg); border: 1px solid var(--border); color: var(--text); font-family: 'SF Mono', monospace; letter-spacing: -0.5px; }
        .badge-cat { background: var(--card-bg); color: var(--sub-text); transition: background 0.3s, color 0.3s; }
        .cat-vfr { background-color: var(--success) !important; color: #000 !important; }
        .cat-mvfr { background-color: var(--mvfr) !important; color: #fff !important; }
        .cat-ifr { background-color: var(--danger) !important; color: #fff !important; }
        .cat-lifr { background-color: var(--lifr) !important; color: #fff !important; }

        .tabs { display: flex; border-bottom: 1px solid var(--border); gap: 15px; padding: 0 4px; overflow-x: auto; scrollbar-width: none; }
        .tab { padding: 10px 0; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--sub-text); border-bottom: 2px solid transparent; text-transform: uppercase; white-space: nowrap; }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

        .view-section { display: none; }
        .view-section.active { display: block; }
        .hidden { display: none !important; }
        .section-title { font-weight:700; color:var(--sub-text); margin: 20px 0 8px 0; font-size:12px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .raw-text { 
            font-family: 'SF Mono', monospace; font-size: 13px; color: #d0d0d0; 
            margin-top: 6px; line-height: 1.4; white-space: pre-wrap; word-break: break-word; 
            background: rgba(255,255,255,0.05); padding: 8px; border-radius: 6px; 
        }

        /* --- QUICK SELECT --- */
        .quick-select-row {
            display: flex; gap: 8px; margin-bottom: 8px; overflow-x: auto; scrollbar-width: none;
            min-height: 32px; 
        }
        .quick-chip {
            background: var(--card-bg); border: 1px solid var(--border); color: var(--text);
            padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer;
            white-space: nowrap; transition: background 0.2s;
        }
        .quick-chip:active { background: var(--accent); color: #fff; border-color: var(--accent); }

        /* --- METAR GRID & VISUALS --- */
        .metar-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .metar-card { background: var(--card-bg); border-radius: 8px; padding: 10px; display: flex; flex-direction: column; justify-content: center; }
        .metar-card.full-width { grid-column: span 2; }
        .m-label { font-size: 11px; color: var(--sub-text); font-weight: 600; text-transform: uppercase; margin-bottom: 4px; }
        .m-value { font-size: 16px; font-weight: 600; color: var(--text); }
        .m-sub { font-size: 12px; color: var(--sub-text); font-weight: 400; margin-left: 4px;}
        .metar-footer { display: flex; justify-content: space-between; margin-top: 8px; padding: 0 4px; font-size: 12px; color: var(--sub-text); }
        
        /* Sky Section */
        .sky-section {
            grid-column: span 2; background: var(--sky-bg); border-radius: 12px; padding: 16px; position: relative; overflow: hidden;
        }
        .sky-header { font-size: 11px; color: rgba(255,255,255,0.4); font-weight: 700; margin-bottom: 12px; text-transform: uppercase; }
        .sky-layer { display: flex; flex-direction: column; margin-bottom: 14px; }
        .sky-icons-row { display: flex; gap: 12px; margin-bottom: 4px; align-items: flex-end; }
        .sky-icon { width: 32px; height: 20px; fill: #d1d5db; opacity: 0.9; }
        .sky-layer-text { font-size: 15px; font-weight: 500; color: #fff; }
        .sky-no-data { text-align: center; color: rgba(255,255,255,0.3); padding: 20px; font-style: italic; }

        /* --- FLIGHT RULE GAUGES --- */
        .fr-bar-container { grid-column: span 2; background: var(--card-bg); padding: 12px; border-radius: 8px; margin-top: 4px; }
        .fr-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .fr-title { font-size: 11px; color: var(--sub-text); font-weight: 700; text-transform: uppercase; }
        
        .fr-gauge-group { display: flex; flex-direction: column; gap: 14px; }
        .fr-row-label { display: flex; justify-content: space-between; font-size: 11px; font-weight: 700; color: var(--sub-text); margin-bottom: 6px; text-transform: uppercase; }
        .fr-val-text { color: var(--text); font-family: 'SF Mono', monospace; font-size: 12px; }
        .fr-track-modern { position: relative; height: 10px; background: #333; border-radius: 5px; overflow: hidden; display: flex; }
        .fr-sec { height: 100%; border-right: 1px solid rgba(0,0,0,0.3); position: relative; background: rgba(255,255,255,0.02); }
        .fr-sec span { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 7px; color: rgba(255,255,255,0.2); font-weight: 800; pointer-events: none; z-index: 1; letter-spacing: 0.5px; }
        .fr-fill-bar { position: absolute; top: 0; left: 0; bottom: 0; background: var(--accent); border-right: 2px solid #fff; box-shadow: 2px 0 8px rgba(0,0,0,0.5); transition: width 1s cubic-bezier(0.1, 1.2, 0.3, 1), background-color 0.3s; z-index: 2; opacity: 0.9; border-radius: 5px 0 0 5px; }
        .fr-msg { margin-top: 12px; font-size: 13px; color: var(--text); font-weight: 500; border-top: 1px solid var(--border); padding-top: 8px; }

        /* --- METEOGRAM STYLES --- */
        .meteogram-container {
            background: var(--card-bg); border-radius: 8px; padding: 8px; position: relative;
            border: 1px solid var(--border); overflow-x: auto; 
        }
        #meteoCanvas { width: 100%; height: 150px; display: block; }

        /* Wind & Vis */
        .wind-vis-container { background: var(--card-bg); border-radius: 8px; padding: 12px; margin-top: 12px; display: flex; gap: 15px; align-items: center; }
        .wind-controls { flex-grow: 1; display: flex; flex-direction: column; gap: 8px; }
        .wind-stats { font-family: 'SF Mono', monospace; font-size: 13px; color: var(--text); margin-top: 5px; }
        .stat-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #333; }
        select.stealth-select { background: #2c2c2e; border: 1px solid var(--border); color: #fff; padding: 6px; border-radius: 6px; width: 100%; font-weight: 600; outline: none; }

        /* TAF */
        .taf-viz-container { margin-top: 10px; position: relative; }
        .taf-bar { display: flex; height: 32px; width: 100%; background: #2c2c2e; border-radius: 6px; overflow: hidden; border: 1px solid var(--border); position: relative; z-index: 2; }
        .taf-sky-strip { height: 6px; width: 100%; margin-top: 2px; border-radius: 3px; background: #333; overflow: hidden; position: relative; }
        .taf-axis { display: flex; width: 100%; margin-top: 4px; margin-bottom: 12px; }
        .taf-block { cursor: pointer; position: relative; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 800; color: rgba(0,0,0,0.6); border-right: 1px solid rgba(0,0,0,0.1); transition: opacity 0.2s; text-transform: uppercase; }
        .taf-block:hover { opacity: 0.8; }
        .taf-detail-card { position: relative; z-index: 10; background: var(--card-bg); border-radius: 8px; padding: 16px; border-left: 4px solid var(--sub-text); animation: slideUpFade 0.2s ease-out; }
        #tafNeedle { position: absolute; top: -4px; height: 40px; width: 2px; background: #ff453a; z-index: 5; pointer-events: none; box-shadow: 0 0 8px #ff453a; transition: left 0.5s ease-out; display: none; }
        #tafNeedle::after { content: ''; position: absolute; top: -4px; left: -4px; width: 10px; height: 10px; background: #ff453a; border-radius: 50%; border: 2px solid #000; }

        /* Runways & Buttons */
        .rwy-complex { margin-bottom: 16px; }
        .rc-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 4px; padding: 0 4px; }
        .rc-idents { font-size: 16px; font-weight: 800; font-family: 'SF Mono', monospace; }
        .rc-strip { height: 44px; background: var(--strip-bg); border-radius: 8px; display: flex; align-items: center; justify-content: space-between; padding: 0 6px; overflow: hidden; position: relative; }
        .rc-id-v { font-size: 12px; font-weight: 700; color: #fff; writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); padding: 0 4px; }
        .rc-data { flex-grow: 1; display: flex; align-items: center; justify-content: center; gap: 12px; }
        .wind-comp { display: flex; align-items: center; gap: 2px; font-size: 14px; font-weight: 600; color: #fff; }
        .atc-btn { display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); padding: 14px 16px; border-radius: 10px; text-decoration: none; color: var(--text); font-weight: 600; font-size: 15px; border: 1px solid var(--border); transition: background 0.2s; margin-bottom: 10px; }
        .atc-btn:hover { background: #2c2c2e; border-color: var(--accent); }
        .tool-btn { background: #333; border: 1px solid var(--border); color: #fff; width: 100%; padding: 8px; border-radius: 6px; cursor: pointer; margin-top: 4px; font-weight: 600; }
        
        /* Nearby */
        .nearby-container { grid-column: span 2; display: flex; flex-direction: column; gap: 4px; margin-top: 8px; }
        .nearby-header { font-size: 11px; color: var(--sub-text); font-weight: 700; }
        .nearby-list { display: flex; gap: 6px; flex-wrap: wrap; }
        .nearby-btn { background: #2c2c2e; border: 1px solid var(--border); color: #fff; padding: 6px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px; }

        /* --- UPDATED: iOS Style World Clock --- */
        .clock-list-container {
            display: flex; flex-direction: column; 
            background: #000; border-radius: 10px;
        }
        .clock-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 16px; border-bottom: 1px solid #222;
            position: relative;
        }
        .clock-left { display: flex; flex-direction: column; gap: 2px; }
        .clock-offset { font-size: 13px; color: #8e8e93; font-weight: 400; }
        .clock-city { font-size: 20px; font-weight: 400; color: #fff; }
        .clock-right { display: flex; align-items: center; gap: 10px; }
        .clock-digital { font-size: 38px; font-weight: 300; color: #fff; font-variant-numeric: tabular-nums; letter-spacing: 0.5px; }
        .clock-ampm { font-size: 16px; color: #fff; font-weight: 400; margin-left: 2px; }
        
        /* Delete Button for Edit Mode */
        .delete-btn {
            display: none; align-items: center; justify-content: center;
            width: 22px; height: 22px; border-radius: 50%;
            background: var(--danger); color: #fff; font-weight: 800; font-size: 14px;
            margin-right: 12px; cursor: pointer;
        }
        .editing .delete-btn { display: flex; animation: slideInLeft 0.2s ease-out; }
        @keyframes slideInLeft { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }

        /* Conv Inputs */
        .conv-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .conv-lbl { font-size: 10px; color: var(--sub-text); margin-bottom: 4px; text-transform: uppercase; }
        .conv-inp { width: 100%; background: #333; border: 1px solid #555; color: #fff; padding: 8px; border-radius: 6px; font-size: 16px; font-weight: 600; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="search-wrapper">
            <div class="search-box">
                <span style="padding-left:4px">üîç</span>
                <input type="text" id="icao" 
                       placeholder="Search (e.g. KJFK)" 
                       onkeydown="if(event.key==='Enter') loadData()" 
                       oninput="toggleClearBtn()"
                       autocapitalize="characters" 
                       autocomplete="off" 
                       autocorrect="off" 
                       spellcheck="false">
                <span id="clearBtn" class="clear-btn" onclick="clearSearch()">‚úñ</span>
                <button class="icon-btn" onclick="locateUser()" title="Near Me (GPS)" style="border:none; background:transparent; width:30px; font-size:16px;">üìç</button>
            </div>
        </div>
        <button class="icon-btn" onclick="loadData()" title="Force Refresh">‚Üª</button>
        
        <div id="headerCat" class="badge badge-cat">--</div>
        <div id="zuluTime" class="badge badge-time">--:--Z</div>
        <a id="linkSkyVector" href="#" target="_blank" class="icon-btn" title="Charts">üó∫Ô∏è</a>
    </div>

    <div class="quick-select-row" id="recentHistoryRow">
        </div>

    <div id="minBanner" class="hidden" style="padding: 8px; text-align: center; font-weight: 800; font-size: 14px; margin-bottom: 8px; border-radius: 6px; cursor: pointer; background: var(--danger);" onclick="setTab('tools')">
        ‚ö†Ô∏è NO-GO CHECK TOOLS
    </div>

    <div class="tabs">
        <div class="tab active" onclick="setTab('metar')">METAR</div>
        <div class="tab" onclick="setTab('taf')">TAF</div>
        <div class="tab" onclick="setTab('info')">INFO</div>
        <div class="tab" onclick="setTab('atc')">ATC</div>
        <div class="tab" onclick="setTab('world')">WORLD</div>
        <div class="tab" onclick="setTab('tools')">TOOLS</div>
        <div class="tab" onclick="setTab('settings')">SETTINGS</div>
    </div>

    <div id="tab-metar" class="view-section active">
        
        <div class="wind-vis-container">
            <canvas id="windRose" width="140" height="140" style="width:140px; height:140px;"></canvas>
            <div class="wind-controls">
                <div class="m-label">Selected Runway</div>
                <select id="rwySelect" class="stealth-select" onchange="drawWindRose()">
                    <option value="">Loading...</option>
                </select>
                <div class="wind-stats">
                    <div class="stat-row"><span class="info-label">Headwind</span> <span id="valHW">--</span></div>
                    <div class="stat-row"><span class="info-label">Crosswind</span> <span id="valXW">--</span></div>
                </div>
            </div>
        </div>

        <div class="metar-grid">
            <div id="skyVisuals" class="sky-section">
                <div class="sky-header">Sky Cover (AGL)</div>
                <div id="skyLayersContainer">
                    <div class="sky-no-data">Scanning Sky...</div>
                </div>
            </div>

            <div class="fr-bar-container">
                <div class="fr-header-row">
                    <div class="fr-title">Flight Category Breakdown</div>
                </div>
                <div class="fr-gauge-group">
                    <div>
                        <div class="fr-row-label"><span>Ceiling</span><span id="labelCeilVal" class="fr-val-text">--</span></div>
                        <div class="fr-track-modern">
                            <div class="fr-sec" style="width: 25%"><span>LIFR</span></div> 
                            <div class="fr-sec" style="width: 25%"><span>IFR</span></div>  
                            <div class="fr-sec" style="width: 25%"><span>MVFR</span></div> 
                            <div class="fr-sec" style="width: 25%; border:none;"><span>VFR</span></div>  
                            <div id="gaugeCeil" class="fr-fill-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div>
                        <div class="fr-row-label"><span>Visibility</span><span id="labelVisVal" class="fr-val-text">--</span></div>
                        <div class="fr-track-modern">
                            <div class="fr-sec" style="width: 25%"><span>LIFR</span></div>
                            <div class="fr-sec" style="width: 25%"><span>IFR</span></div>
                            <div class="fr-sec" style="width: 25%"><span>MVFR</span></div>
                            <div class="fr-sec" style="width: 25%; border:none;"><span>VFR</span></div>
                            <div id="gaugeVis" class="fr-fill-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>
                <div id="frMessage" class="fr-msg">--</div>
            </div>
            
            <div class="metar-card"><div class="m-label">WIND</div><div class="m-value" id="mWind">--</div></div>
            <div class="metar-card"><div class="m-label">VISIBILITY</div><div class="m-value" id="mVis">--</div></div>
            <div class="metar-card"><div class="m-label">CEILING</div><div class="m-value" id="mCeil">--</div></div>
            <div class="metar-card"><div class="m-label">ALTIMETER</div><div class="m-value" id="mAlt">--</div></div>
            <div class="metar-card full-width"><div class="m-label">TEMP / DEWPOINT</div><div class="m-value"><span id="mTempC">--</span> <span id="mTempF" class="m-sub">--</span></div></div>
        </div>

        <div class="raw-text" id="rawMetar">Select an airport above.</div>
        <div class="metar-footer"><span id="mAge">--</span><span id="mSpread">Spread: --</span></div>
        
        <div id="nearbyContainer" class="nearby-container">
            <div class="nearby-header">NEARBY STATIONS</div>
            <div id="nearList" class="nearby-list">
                <span style="color:var(--sub-text); font-size:12px;">--</span>
            </div>
        </div>
    </div>

    <div id="tab-taf" class="view-section">
        <div style="display:flex; justify-content:space-between; align-items:center; color:var(--sub-text); font-size:12px; margin-bottom:8px;">
            <span>24H Trend (Open-Meteo)</span>
            <span style="background:var(--warn); color:#000; padding:2px 6px; border-radius:4px; font-weight:800; font-size:10px;">‚ö†Ô∏è ADVISORY only</span>
        </div>
        <div class="meteogram-container">
            <canvas id="meteoCanvas" height="150"></canvas>
            <div id="meteoLoading" class="sky-no-data" style="position:absolute; top:50%; left:0; right:0; text-align:center;">Select Airport</div>
        </div>
        <div style="display:flex; justify-content:space-between; color:var(--sub-text); font-size:12px; margin-bottom:8px; margin-top:20px; border-top:1px solid #333; padding-top:15px;">
            <span>Official Forecast Visualization</span><span id="tafIssued">--</span>
        </div>
        <div class="taf-viz-container">
            <div id="tafNeedle"></div>
            <div id="tafBar" class="taf-bar"></div>
            <div id="tafSkyStrip" class="taf-sky-strip"></div>
            <div id="tafAxis" class="taf-axis"></div>
            <div id="tafDetail" class="taf-detail-card hidden">
                <div class="td-header" style="display:flex; justify-content:space-between; margin-bottom:12px;"><span id="tdTime" style="font-weight:700;">--</span><span id="tdType" style="background:#444; padding:2px 6px; border-radius:4px; color:#fff;">--</span></div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <div><span class="m-label">WIND</span><div id="tdWind" style="font-weight:600;">--</div></div>
                    <div><span class="m-label">VISIBILITY</span><div id="tdVis" style="font-weight:600;">--</div></div>
                    <div><span class="m-label">WEATHER</span><div id="tdWx" style="font-weight:600;">--</div></div>
                    <div><span class="m-label">CLOUDS</span><div id="tdCloud" style="font-weight:600;">--</div></div>
                </div>
            </div>
        </div>
        <div style="margin-top:20px; font-weight:700; color:var(--sub-text);">Raw TAF</div>
        <div class="raw-text" id="rawTaf">Loading...</div>
        <div style="margin-top:20px; font-weight:700; color:var(--sub-text);">NOTAMs</div>
        <div id="notamList" class="raw-text" style="max-height:300px; overflow-y:auto; font-size:11px; background:transparent; padding:0;">Loading...</div>
    </div>
    
    <div id="tab-info" class="view-section">
        <div style="font-size:20px; font-weight:700; margin-bottom:4px;" id="infoName">Unknown</div>
        <div style="font-size:12px; color:var(--sub-text); margin-bottom:12px;" id="infoLoc">--</div>
        <div class="info-grid">
            <div class="info-card"><div class="ic-lbl">ICAO / IATA</div><div class="ic-val" id="infoCodes">--</div></div>
            <div class="info-card"><div class="ic-lbl">Elevation</div><div class="ic-val" id="infoElev">--</div></div>
            <div class="info-card" style="grid-column: span 2;"><div class="ic-lbl">Coordinates</div><div class="ic-val" style="font-size:13px;" id="infoCoords">--</div></div>
        </div>
        <div class="section-title">ATMOSPHERE & TIME</div>
        <div class="info-grid">
            <div class="info-card"><div class="ic-lbl">Pressure Alt</div><div class="ic-val" id="calcPA">--</div></div>
            <div class="info-card"><div class="ic-lbl">Density Alt</div><div class="ic-val" id="calcDA">--</div></div>
            <div class="info-card"><div class="ic-lbl">ISA Dev</div><div class="ic-val" id="calcISA">--</div></div>
            <div class="info-card"><div class="ic-lbl">Sunrise/Set</div><div class="ic-val" style="font-size:13px;" id="infoSun">--</div></div>
        </div>
        <div class="section-title">RUNWAYS & FREQ</div>
        <div id="freqContainer" class="freq-grid"></div>
        <div class="section-title">RUNWAY WIND COMPONENTS</div>
        <div id="runwayListComplex"></div>
    </div>
    
    <div id="tab-atc" class="view-section">
        <div class="info-card" style="margin-bottom: 20px;">
             <div class="ic-lbl" style="margin-bottom:8px;" id="audioLabel">AUDIO STREAMS</div>
             <div id="audioPlayerTarget">
                 <div style="color:var(--sub-text); font-style:italic; padding:10px; text-align:center;">
                     Select an airport to check for streams.
                 </div>
             </div>
        </div>
        <div class="section-title">EXTERNAL RESOURCES</div>
        <a href="https://metar-taf.com/" target="_blank" class="atc-btn"><span>‚òÅÔ∏è Metar-Taf.com</span><span>‚Üó</span></a>
        <a href="https://beta.twatc.net/" target="_blank" class="atc-btn"><span>üáπüáº Taiwan Virtual ATC</span><span>‚Üó</span></a>
        <a id="btnLiveAtc" href="https://www.liveatc.net/" target="_blank" class="atc-btn"><span>üì° LiveATC.net</span><span>‚Üó</span></a>
    </div>

    <div id="tab-world" class="view-section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
             <div style="font-size:24px; font-weight:700;">World Clock</div>
             <div style="color:var(--accent); font-weight:600; cursor:pointer;" onclick="toggleEditClock()" id="editClockBtn">Edit</div>
        </div>
        
        <div style="display:flex; gap:8px; margin-bottom:16px; background:var(--card-bg); padding:8px; border-radius:8px;">
            <input type="text" id="newCityInput" class="conv-inp" placeholder="City (Paris) or ICAO (KJFK)..." style="margin:0;">
            <button id="btnAddCity" class="tool-btn" style="width:auto; margin:0; background:var(--accent); border:none;" onclick="addCustomCity()">
                <span>Add</span>
            </button>
        </div>
        
        <div id="worldContainer" class="clock-list-container">
            </div>
    </div>

    <div id="tab-tools" class="view-section">
        <div class="section-title" style="margin-top:0;">Personal Minimums</div>
        <div class="info-card" style="border-left: 4px solid #555;" id="minsCard">
            <div class="conv-row">
                <div style="flex:1">
                    <div class="conv-lbl">Max X-Wind (kt)</div>
                    <input type="number" id="minXW" class="conv-inp" placeholder="e.g. 15" oninput="checkMins()" autocomplete="off">
                </div>
                <div style="flex:1">
                    <div class="conv-lbl">Min Ceiling (ft)</div>
                    <input type="number" id="minCeil" class="conv-inp" placeholder="e.g. 1000" oninput="checkMins()" autocomplete="off">
                </div>
            </div>
            <div id="minsResult" style="margin-top:10px; font-weight:800; font-size:18px; text-align:center; padding:10px; border-radius:6px; background:#333; color:#aaa;">SET LIMITS</div>
        </div>

        <div class="section-title">E6B Flight Computer</div>
        <div class="info-card">
            <div class="conv-row">
                <div style="flex:1"><div class="conv-lbl">Alt (ft)</div><input type="number" id="e6bAlt" class="conv-inp" oninput="calcE6B()"></div>
                <div style="flex:1"><div class="conv-lbl">QNH (hPa)</div><input type="number" id="e6bQnh" class="conv-inp" value="1013" oninput="calcE6B()"></div>
                <div style="flex:1"><div class="conv-lbl">Temp (¬∞C)</div><input type="number" id="e6bTemp" class="conv-inp" oninput="calcE6B()"></div>
            </div>
            <div class="conv-row">
                <div style="flex:1"><div class="conv-lbl">IAS (kts)</div><input type="number" id="e6bIas" class="conv-inp" oninput="calcE6B()"></div>
            </div>
            <div class="info-grid" style="margin-top:10px;">
                <div><div class="ic-lbl">Density Alt</div><div class="ic-val" id="resDA" style="color:var(--accent);">--</div></div>
                <div><div class="ic-lbl">TAS</div><div class="ic-val" id="resTAS" style="color:var(--success);">--</div></div>
            </div>
        </div>
    </div>

    <div id="tab-settings" class="view-section">
        <div class="section-title" style="margin-top:0;">Startup Preferences</div>
        
        <div class="info-card">
            <div class="conv-lbl">Default Airport (ICAO)</div>
            <div class="conv-row" style="margin-bottom:0;">
                <input type="text" id="defaultIcaoInput" class="conv-inp" placeholder="e.g. RCTP" style="text-transform:uppercase;" maxlength="4">
                <button class="tool-btn" style="width:auto; margin:0;" onclick="saveDefaultStation()">Save</button>
            </div>
            <div id="saveMsg" style="font-size:12px; color:var(--success); margin-top:8px; height:14px;"></div>
        </div>
    
        <div class="section-title">Visuals</div>
        <button id="btnNightMode" class="atc-btn" onclick="toggleNightMode()" style="justify-content:center; margin-bottom:20px; border:1px solid var(--danger);">
            <span>üî¥ Cockpit Night Mode</span>
        </button>
        
        <div class="section-title">Data & Storage</div>
        <div class="info-card">
            <div style="font-size:12px; color:var(--sub-text); margin-bottom:8px;">
                Clear all saved data (Minimums, Default Airport, Cities).
            </div>
            <button class="tool-btn" style="background:var(--card-bg); border:1px solid var(--danger); color:var(--danger);" onclick="resetApp()">Factory Reset App</button>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION & STATE ---

        // FAILOVER API KEYS
        const API_KEYS = [
            'L1rylGsq_pzzgadZkxQGIp3V_VJmLhDIy7UZe_XjhL4',
            '2mT6ZhJh6GZygRttPVdMTt_XgGNnCZCg9ulp_wlnSDI',
            'MfB7DS2UFeFiE95bbEzMhdHXWLJdFGOkMwqNaQieGEw',
            '7BVPOe0lM6CvvLCOGwmcmCxTp1n6PgCdcBJ9Lnt3WpI'
        ];
        
        let currentKeyIndex = 0;
        let currentWind = { dir:0, spd:0 }; 
        let currentMetar = { temp: 15, alt: 1013, altUnit: 'hPa' };
        let stationData = null;
        let stationSunTimes = null;
        let useMetric = true; 
        let tafDataCache = null;
        let lastMetarObj = null; 
        let meteoDataCache = null;

        // Default cities for world clock
        const DEFAULT_CITIES = [
            {n:"Taipei", z:"Asia/Taipei"}, 
            {n:"San Francisco", z:"America/Los_Angeles"}, 
            {n:"New York", z:"America/New_York"}, 
            {n:"London", z:"Europe/London"},
            {n:"Tokyo", z:"Asia/Tokyo"}
        ];
        let cityList = [];
        let isClockEditMode = false;

        const CLOUD_ICON_PATH = "M25 15C25 10.58 21.42 7 17 7C16.5 7 16 7.05 15.54 7.15C14.73 4.19 12.06 2 9 2C5.13 2 2 5.13 2 9C2 9.17 2 9.35 2.03 9.5C0.84 10.19 0 11.5 0 13C0 15.21 1.79 17 4 17H25C27.76 17 30 14.76 30 12C30 9.24 27.76 7 25 7V15Z";

        // --- 2. INITIALIZATION ---

        function initApp() {
            initWorldClock();
            checkNightModeSaved();
            renderHistory(); 

            // Load Default Station Preference
            const savedDefault = localStorage.getItem('efb_default_station');
            const inputField = document.getElementById('defaultIcaoInput');
            
            if (savedDefault) {
                inputField.value = savedDefault;
                document.getElementById('icao').value = savedDefault;
                loadData(); 
            } else {
                document.getElementById('icao').value = "";
            }
            
            const savedXW = localStorage.getItem('efb_min_xw');
            const savedCeil = localStorage.getItem('efb_min_ceil');
            if(savedXW) document.getElementById('minXW').value = savedXW;
            if(savedCeil) document.getElementById('minCeil').value = savedCeil;

            setInterval(updateClock, 1000);
        }

        // --- 3. FAILOVER NETWORK LAYER (SMART FETCH) ---

        function getHeaders() {
            return { 'Authorization': `Bearer ${API_KEYS[currentKeyIndex]}` };
        }

        async function smartFetch(url) {
            for (let i = 0; i < API_KEYS.length; i++) {
                try {
                    const res = await fetch(url, { headers: getHeaders() });
                    if (res.ok) return res;
                    if (res.status === 429 || res.status === 401) {
                        console.warn(`Key ${currentKeyIndex} exhausted. Switching...`);
                        currentKeyIndex = (currentKeyIndex + 1) % API_KEYS.length;
                        continue; 
                    }
                    return res;
                } catch (err) {
                    console.error("Network error, retrying...", err);
                }
            }
            throw new Error("All API keys exhausted or network down.");
        }

        // --- 4. WORLD CLOCK LOGIC (iOS STYLE) ---

        function initWorldClock() {
            const stored = localStorage.getItem('efb_cities_v47');
            if(stored) cityList = JSON.parse(stored); else cityList = [...DEFAULT_CITIES];
        }

        function toggleEditClock() {
            isClockEditMode = !isClockEditMode;
            document.getElementById('editClockBtn').innerText = isClockEditMode ? "Done" : "Edit";
            updateClock(); // Re-render immediately
        }

        function deleteCity(index) {
            cityList.splice(index, 1);
            localStorage.setItem('efb_cities_v47', JSON.stringify(cityList));
            updateClock();
        }

        // SMART SEARCH: Handles both ICAO and City Names
        async function addCustomCity() {
            const btn = document.getElementById('btnAddCity');
            const input = document.getElementById('newCityInput');
            const val = input.value.trim();
            if(!val) return;

            btn.innerText = "‚è≥";
            
            try {
                let cityName = val;
                let finalCity = "";
                let finalTz = "";

                // 1. If it looks like an ICAO (3-4 UPCASE letters), try AVWX first
                if (val.length >= 3 && val.length <= 4 && /^[A-Z]+$/.test(val.toUpperCase())) {
                    try {
                        const res = await smartFetch(`https://avwx.rest/api/station/${val.toUpperCase()}`);
                        if(res.ok) {
                            const data = await res.json();
                            cityName = data.city; // Use the official city name from AVWX
                            console.log(`Resolved ICAO ${val} to City: ${cityName}`);
                        }
                    } catch(e) {
                        console.log("ICAO lookup failed, trying as city name...");
                    }
                }

                // 2. Resolve Timezone using Open-Meteo Geocoding
                // This works for both "London" (typed directly) and "London" (resolved from EGLL)
                const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${cityName}&count=1&language=en&format=json`);
                const geoData = await geoRes.json();

                if (geoData.results && geoData.results.length > 0) {
                    finalCity = geoData.results[0].name;
                    finalTz = geoData.results[0].timezone;
                    
                    cityList.push({n: finalCity, z: finalTz});
                    localStorage.setItem('efb_cities_v47', JSON.stringify(cityList));
                    
                    input.value = "";
                    updateClock();
                } else {
                    alert("Could not find city or timezone.");
                }

            } catch(e) {
                console.error(e);
                alert("Error adding city. Check connection.");
            } finally {
                btn.innerText = "Add";
            }
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('zuluTime').innerText = `${now.getUTCHours().toString().padStart(2,'0')}:${now.getUTCMinutes().toString().padStart(2,'0')}Z`;
            
            if(document.getElementById('tab-world').classList.contains('active')) {
                const container = document.getElementById('worldContainer'); 
                container.innerHTML = '';

                cityList.forEach((c, index) => {
                    // Time formatting
                    const options = { timeZone: c.z, hour: 'numeric', minute: '2-digit', hour12: false };
                    const timeStr = new Intl.DateTimeFormat('en-US', options).format(now);
                    
                    // Offset Calculation (e.g., +8HRS)
                    // We cheat slightly by comparing hours, dealing with day boundaries is complex but this is close enough for simple display
                    const localDate = new Date(now.toLocaleString('en-US', { timeZone: c.z }));
                    const utcDate = new Date(now.toLocaleString('en-US', { timeZone: 'UTC' }));
                    let diffHours = (localDate.getTime() - utcDate.getTime()) / 1000 / 60 / 60;
                    
                    // Fix JS float weirdness and wrap-around
                    // Actually, simpler: Use the TZ offset from date string
                    // But relative to USER is what Apple does. "Today, +0HRS" means relative to current user time.
                    const userDate = new Date();
                    const diffMs = localDate.getTime() - userDate.getTime(); 
                    // This comparison is tricky because "localDate" created above effectively strips TZ.
                    // Let's stick to strict UTC offset for simplicity or just "Timezone Relative"
                    // Apple's "Today, +0HRS" is relative to the *user*.
                    // Let's approximate:
                    const localHour = localDate.getHours();
                    const userHour = userDate.getHours();
                    let diff = localHour - userHour;
                    if (diff < -12) diff += 24;
                    if (diff > 12) diff -= 24;
                    
                    const sign = diff >= 0 ? "+" : "";
                    const offsetStr = `Today, ${sign}${diff}HRS`; // Simplified logic

                    const row = document.createElement('div');
                    row.className = 'clock-row';
                    if(isClockEditMode) row.classList.add('editing');

                    row.innerHTML = `
                        <div style="display:flex; align-items:center;">
                            <div class="delete-btn" onclick="deleteCity(${index})">‚îÄ</div>
                            <div class="clock-left">
                                <div class="clock-offset">${offsetStr}</div>
                                <div class="clock-city">${c.n}</div>
                            </div>
                        </div>
                        <div class="clock-right">
                            <div class="clock-digital">${timeStr}</div>
                        </div>
                    `;
                    container.appendChild(row);
                });
            }
        }

        // --- 5. CORE DATA LOGIC ---

        function quickLoad(code) {
            document.getElementById('icao').value = code;
            loadData();
        }

        function saveDefaultStation() {
            const val = document.getElementById('defaultIcaoInput').value.trim().toUpperCase();
            const msg = document.getElementById('saveMsg');
            
            if(val.length >= 3) {
                localStorage.setItem('efb_default_station', val);
                msg.innerText = "Default station saved! Will load on startup.";
                setTimeout(() => { msg.innerText = ""; }, 3000);
            } else {
                msg.style.color = "var(--warn)";
                msg.innerText = "Invalid ICAO code.";
            }
        }

        function resetApp() {
            if(confirm("Reset all settings and clear local data?")) {
                localStorage.clear();
                location.reload();
            }
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem('efb_history')) || [];
            const container = document.getElementById('recentHistoryRow');
            container.innerHTML = '';
            
            if (history.length === 0) {
                const defaults = ['RCTP', 'RCSS', 'KSFO', 'RJAA'];
                defaults.forEach(d => {
                     const chip = document.createElement('div');
                     chip.className = 'quick-chip';
                     chip.innerText = d;
                     chip.onclick = () => quickLoad(d);
                     container.appendChild(chip);
                });
                return;
            }

            history.forEach(icao => {
                const chip = document.createElement('div');
                chip.className = 'quick-chip';
                chip.innerText = icao;
                chip.onclick = () => quickLoad(icao);
                container.appendChild(chip);
            });
        }

        function addToHistory(icao) {
            let history = JSON.parse(localStorage.getItem('efb_history')) || [];
            history = history.filter(item => item !== icao); 
            history.unshift(icao); 
            if (history.length > 5) history.pop(); 
            localStorage.setItem('efb_history', JSON.stringify(history));
            renderHistory();
        }

        function locateUser() {
            const btn = document.querySelector('.search-box button');
            const originalIcon = 'üìç';
            btn.innerHTML = '‚è≥'; 
            
            if (!navigator.geolocation) {
                alert("Geolocation not supported");
                btn.innerHTML = originalIcon;
                return;
            }

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                try {
                    const res = await smartFetch(`https://avwx.rest/api/station/near/${lat},${lon}?n=1`);
                    const data = await res.json();
                    if (data.length > 0) {
                        const nearest = data[0].station.icao;
                        document.getElementById('icao').value = nearest;
                        loadData();
                    } else {
                        alert("No aviation stations found nearby.");
                    }
                } catch(e) {
                    console.error(e);
                    alert("Error finding station via GPS.");
                } finally {
                     btn.innerHTML = originalIcon;
                }
            }, (err) => {
                console.error(err);
                alert("GPS permission denied or unavailable.");
                btn.innerHTML = originalIcon;
            });
        }

        async function loadData() {
            const icaoVal = document.getElementById('icao').value;
            if(!icaoVal) return;
            const icao = icaoVal.toUpperCase();
            addToHistory(icao); 

            document.getElementById('icao').blur();
            document.getElementById('linkSkyVector').href = `https://skyvector.com/airport/${icao}`;
            updateHeaderCat('Loading', '');
            
            const rawContainer = document.getElementById('rawMetar');
            rawContainer.innerHTML = 'Loading...';
            document.getElementById('nearList').innerHTML = '<span style="color:#555;">Scanning...</span>';

            const cb = Date.now();
            
            try {
                // 1. Station
                const stationResp = await smartFetch(`https://avwx.rest/api/station/${icao}?t=${cb}`);
                if(!stationResp.ok) throw new Error("Station Not Found");
                stationData = await stationResp.json();
                renderInfo(stationData); 
                
                // Meteogram
                fetchMeteogram(stationData.latitude, stationData.longitude);

                // 2. Weather
                const [metarRes, tafRes, notamRes] = await Promise.allSettled([
                    smartFetch(`https://avwx.rest/api/metar/${icao}?t=${cb}`).then(r=>r.json()),
                    smartFetch(`https://avwx.rest/api/taf/${icao}?t=${cb}`).then(r=>r.json()),
                    smartFetch(`https://avwx.rest/api/notam/${icao}?t=${cb}`).then(r=>r.json())
                ]);

                // METAR
                if(metarRes.status === 'fulfilled' && !metarRes.value.error) {
                    const m = metarRes.value;
                    lastMetarObj = m;
                    currentWind = { dir: m.wind_direction?.value||0, spd: m.wind_speed?.value||0 };
                    
                    let altVal = m.altimeter?.value || 1013;
                    let altUnit = altVal < 200 ? 'inHg' : 'hPa';
                    currentMetar = { temp: m.temperature?.value || 15, alt: altVal, altUnit: altUnit };
                    
                    renderMetar(m); 
                    renderSkyVisuals(m);
                    renderFlightRuleBar(m); 
                    setupRunwaySelect();
                    findNearbyStations(stationData.latitude, stationData.longitude); 
                    updateAudioSection(icao);
                } else {
                    throw new Error("No Weather Data");
                }

                // TAF
                if(tafRes.status === 'fulfilled') renderTaf(tafRes.value);
                
                // NOTAMs
                if(notamRes.status === 'fulfilled') {
                    const n = notamRes.value;
                    const notamContainer = document.getElementById('notamList');
                    if (Array.isArray(n) && n.length > 0) {
                        const critical = []; const warning = []; const info = [];
                        n.forEach(x => {
                            const raw = x.raw;
                            if (/(CLSD|CLOSED|U\/S|UNSERVICEABLE|FAIL)/.test(raw)) critical.push(x);
                            else if (/(OBST|WORK|WIP|TRIGGER|SNOW|ICE|DANGER)/.test(raw)) warning.push(x);
                            else info.push(x);
                        });
                        const renderGroup = (list, title, color) => {
                            if(list.length === 0) return '';
                            return `
                                <div style="color:${color}; font-weight:800; margin:14px 0 4px 0; font-size:11px; text-transform:uppercase;">${title} (${list.length})</div>
                                ${list.map(x => `
                                    <div style="margin-bottom:6px; border-left:3px solid ${color}; background:rgba(255,255,255,0.03); padding:6px; font-size:11px; font-family:'SF Mono', monospace;">
                                        <div style="color:#666; font-size:9px; margin-bottom:2px;">${x.start_time?.dt ? new Date(x.start_time.dt).toLocaleDateString() : ''}</div>
                                        ${formatNotamText(x.raw)}
                                    </div>
                                `).join('')}
                            `;
                        };
                        notamContainer.innerHTML = renderGroup(critical, '‚õî CRITICAL', '#ff453a') + renderGroup(warning, '‚ö†Ô∏è CAUTION', '#ff9f0a') + renderGroup(info, '‚ÑπÔ∏è INFO', '#8e8e93');
                    } else {
                        notamContainer.innerHTML = "No NOTAMs Found";
                    }
                }

            } catch(e) {
                console.error(e);
                updateHeaderCat('N/A', 'cat-ifr');
                rawContainer.innerHTML = `<div style="text-align:center; padding:20px 10px; color:var(--danger); font-weight:800;">STATION DATA UNAVAILABLE</div>`;
            }
        }

        // --- 6. AUDIO, CHARTS, UTILS ---

        function updateAudioSection(icao) {
            const container = document.getElementById('audioPlayerTarget');
            const label = document.getElementById('audioLabel');
            const liveAtcBtn = document.getElementById('btnLiveAtc');

            if (liveAtcBtn) {
                liveAtcBtn.href = `https://www.liveatc.net/search/?icao=${icao}`;
                liveAtcBtn.innerHTML = `<span>üì° LiveATC (${icao})</span><span>‚Üó</span>`;
            }

            if (icao === 'RCTP') {
                label.innerText = "RCTP LIVE STREAMS (TWATC)";
                container.innerHTML = `
                    <div style="margin-bottom:12px;">
                        <div class="m-label" style="color:var(--accent);">ATIS (127.6)</div>
                        <audio controls style="width: 100%; height: 32px; border-radius:16px;">
                            <source src="https://stream.twatc.net/RCTP_ATIS" type="audio/mpeg">
                        </audio>
                    </div>
                    <div>
                        <div class="m-label" style="color:var(--success);">ATC SCANNER (GND/TWR/APP)</div>
                        <audio controls style="width: 100%; height: 32px; border-radius:16px;">
                            <source src="https://stream.twatc.net/RCTP_Scan2" type="audio/mpeg">
                        </audio>
                    </div>`;
            } else {
                label.innerText = "AUDIO STREAMS";
                container.innerHTML = `<div style="color:var(--sub-text); font-size:13px; text-align:center; padding:10px 0;">No direct in-app stream. Use LiveATC below.</div>`;
            }
        }

        async function fetchMeteogram(lat, lon) {
            const loader = document.getElementById('meteoLoading');
            loader.style.display = 'block';
            meteoDataCache = null; 
            try {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,dewpoint_2m,wind_speed_10m,wind_direction_10m,wind_gusts_10m,weather_code&wind_speed_unit=kn&forecast_days=1`;
                const res = await fetch(url);
                const data = await res.json();
                if(data.hourly) {
                    meteoDataCache = data.hourly; 
                    drawMeteogram(meteoDataCache);
                }
                loader.style.display = 'none';
            } catch(e) {
                loader.innerText = "Model Data Unavailable";
            }
        }

        function drawMeteogram(h) {
            const cvs = document.getElementById('meteoCanvas');
            const ctx = cvs.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            const rect = cvs.getBoundingClientRect();
            cvs.width = rect.width * dpr; cvs.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            const W = rect.width; const H = rect.height;
            const padding = {top: 40, bottom: 35, left: 15, right: 15};
            ctx.clearRect(0,0,W,H);
            const len = 24; 
            let minT = 100, maxT = -100;
            for(let i=0; i<len; i++) {
                minT = Math.min(minT, h.temperature_2m[i], h.dewpoint_2m[i]);
                maxT = Math.max(maxT, h.temperature_2m[i], h.dewpoint_2m[i]);
            }
            minT -= 2; maxT += 2; const rangeT = maxT - minT;
            const getX = (i) => padding.left + (i / (len-1)) * (W - padding.left - padding.right);
            const getY = (val) => H - padding.bottom - ((val - minT) / rangeT) * (H - padding.top - padding.bottom);
            
            // Grid
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.08)'; ctx.lineWidth = 1; ctx.beginPath();
            for(let i=0; i<len; i+=3) { ctx.moveTo(getX(i), padding.top); ctx.lineTo(getX(i), H - padding.bottom); }
            ctx.stroke();

            // Lines
            function drawLine(dataArr, color) {
                ctx.beginPath(); ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.lineJoin = 'round';
                for(let i=0; i<len; i++) { i===0 ? ctx.moveTo(getX(i), getY(dataArr[i])) : ctx.lineTo(getX(i), getY(dataArr[i])); }
                ctx.stroke();
            }
            drawLine(h.dewpoint_2m, '#0a84ff'); drawLine(h.temperature_2m, '#ff453a');

            // Points
            ctx.textAlign = 'center'; ctx.font = '10px sans-serif';
            for(let i=0; i<len; i+=3) {
                const x = getX(i);
                ctx.fillStyle = '#fff'; ctx.fillText(h.weather_code[i]<=3?'‚òÅÔ∏è':'üåßÔ∏è', x, padding.top - 15);
                ctx.fillText(Math.round(h.wind_speed_10m[i]), x, H - 10);
                ctx.fillStyle = '#666'; ctx.fillText(`${i}z`, x, H);
            }
        }

        function renderMetar(d) {
            const rawContainer = document.getElementById('rawMetar');
            const now = new Date(); const metarTime = new Date(d.time.dt);
            const minAgo = Math.floor((now - metarTime) / 60000);
            rawContainer.innerHTML = formatRawMetar(d.raw);
            if (minAgo > 60) rawContainer.insertAdjacentHTML('beforeend', `<div style="margin-top:12px; padding:10px; border:1px solid var(--danger); text-align:center; color:var(--danger);">‚ö†Ô∏è OLD DATA (${minAgo}m)</div>`);
            
            const rules = d.flight_rules;
            updateHeaderCat(rules, rules==='VFR'?'cat-vfr':rules==='MVFR'?'cat-mvfr':rules==='IFR'?'cat-ifr':'cat-lifr');
            
            document.getElementById('mWind').innerText = `${currentWind.dir.toString().padStart(3,'0')}¬∞ / ${currentWind.spd}kt`;
            document.getElementById('mVis').innerText = d.visibility ? `${d.visibility.value} sm` : '--';
            const c = d.clouds?.[0]; 
            document.getElementById('mCeil').innerText = c ? `${c.type} ${c.altitude.toString().padStart(3,'0')}` : "CLR";
            
            if(d.altimeter?.value) {
                const alt = d.altimeter.value;
                currentMetar.altUnit === 'hPa' ? document.getElementById('mAlt').innerText = `Q${alt}` : document.getElementById('mAlt').innerText = `A${alt.toFixed(2)}`;
            }
            if(d.temperature?.value != null) {
                const t = d.temperature.value; const dew = d.dewpoint?.value;
                document.getElementById('mTempC').innerText = `${t}¬∞C / ${dew}¬∞C`;
                document.getElementById('mTempF').innerText = `(${Math.round(t*1.8+32)}¬∞F)`;
                document.getElementById('mSpread').innerText = `Spread: ${(t-dew).toFixed(1)}¬∞C`;
            }
            document.getElementById('mAge').innerText = `${minAgo}m ago`;
        }

        function renderSkyVisuals(m) {
            const container = document.getElementById('skyLayersContainer'); container.innerHTML = '';
            if (!m.clouds || m.clouds.length === 0) { container.innerHTML = '<div class="sky-no-data">Sky Clear (SKC/CLR)</div>'; return; }
            [...m.clouds].sort((a,b) => b.altitude - a.altitude).forEach(c => {
                const layer = document.createElement('div'); layer.className = 'sky-layer';
                let count = c.type === 'FEW' ? 2 : c.type === 'SCT' ? 4 : 7;
                let iconsHtml = ''; for(let i=0; i<count; i++) iconsHtml += `<svg class="sky-icon" viewBox="0 0 30 20"><path d="${CLOUD_ICON_PATH}"/></svg>`;
                layer.innerHTML = `<div class="sky-icons-row">${iconsHtml}</div><div class="sky-layer-text">${c.type} ${c.altitude * 100}'</div>`;
                container.appendChild(layer);
            });
        }

        function renderFlightRuleBar(m) {
            let ceiling = 99999;
            if (m.clouds) { const l = m.clouds.find(c => ['BKN','OVC','VV'].includes(c.type)); if(l) ceiling = l.altitude * 100; }
            let vis = m.visibility ? m.visibility.value : 10;
            
            const getStats = (val, type) => {
                let pct = 0; let col = 'var(--success)';
                if (type === 'ceil') {
                    if (val < 500) { pct = (val/500)*25; col='var(--lifr)'; }
                    else if (val < 1000) { pct = 25+((val-500)/500)*25; col='var(--danger)'; }
                    else if (val < 3000) { pct = 50+((val-1000)/2000)*25; col='var(--mvfr)'; }
                    else { pct = 75; col='var(--success)'; }
                } else {
                    if (val < 1) { pct = (val/1)*25; col='var(--lifr)'; }
                    else if (val < 3) { pct = 25+((val-1)/2)*25; col='var(--danger)'; }
                    else if (val < 5) { pct = 50+((val-3)/2)*25; col='var(--mvfr)'; }
                    else { pct = 100; col='var(--success)'; }
                }
                return {w: Math.max(5, pct)+'%', c: col};
            };
            const cS = getStats(ceiling, 'ceil'); const vS = getStats(vis, 'vis');
            document.getElementById('gaugeCeil').style.width = cS.w; document.getElementById('gaugeCeil').style.backgroundColor = cS.c;
            document.getElementById('labelCeilVal').innerText = ceiling===99999?'Unl':ceiling; document.getElementById('labelCeilVal').style.color = cS.c;
            document.getElementById('gaugeVis').style.width = vS.w; document.getElementById('gaugeVis').style.backgroundColor = vS.c;
            document.getElementById('labelVisVal').innerText = vis; document.getElementById('labelVisVal').style.color = vS.c;
            
            const r = m.flight_rules; 
            const msg = document.getElementById('frMessage');
            msg.innerText = r === 'VFR' ? "Visual Flight Rules" : r === 'MVFR' ? "Marginal VFR" : r === 'IFR' ? "Instrument Flight Rules" : "Low IFR";
            msg.style.color = r==='VFR'?'var(--success)':r==='MVFR'?'var(--mvfr)':r==='IFR'?'var(--danger)':'var(--lifr)';
        }

        async function findNearbyStations(lat, lon) {
            try {
                const res = await smartFetch(`https://avwx.rest/api/station/near/${lat},${lon}?n=5`); 
                const data = await res.json();
                const list = document.getElementById('nearList'); list.innerHTML = "";
                data.filter(i => i.station.icao !== document.getElementById('icao').value.toUpperCase()).slice(0,4).forEach(i => {
                    const btn = document.createElement('div'); btn.className = "nearby-btn";
                    btn.innerHTML = `<span>‚úà</span><span>${i.station.icao}</span><span style="color:#888; font-size:10px;">${Math.round(i.nautical_miles)}nm</span>`;
                    btn.onclick = () => { document.getElementById('icao').value = i.station.icao; loadData(); };
                    list.appendChild(btn);
                });
            } catch(e) {}
        }

        function renderInfo(d) {
            document.getElementById('infoName').innerText = d.name;
            document.getElementById('infoLoc').innerText = `${d.city}, ${d.country} (${d.icao})`;
            document.getElementById('infoCodes').innerText = `${d.icao} / ${d.iata}`;
            document.getElementById('infoElev').innerText = `${d.elevation_ft} ft`;
            document.getElementById('infoCoords').innerText = `${d.latitude.toFixed(4)}, ${d.longitude.toFixed(4)}`;
            
            const pa = Math.round(d.elevation_ft + (1013.25 - (currentMetar.altUnit==='inHg'?currentMetar.alt*33.86:currentMetar.alt)) * 30);
            const da = Math.round(pa + 120 * (currentMetar.temp - (15 - (2*pa/1000))));
            document.getElementById('calcPA').innerText = `${pa} ft`; document.getElementById('calcDA').innerText = `${da} ft`;
            
            const fc = document.getElementById('freqContainer'); fc.innerHTML = '';
            (d.frequencies||[]).slice(0,6).forEach(f => {
                const c = document.createElement('div'); c.className = 'freq-card';
                c.innerHTML = `<div class="freq-type">${f.type}</div><div class="freq-val">${f.frequency}</div>`;
                fc.appendChild(c);
            });
        }

        function setupRunwaySelect() {
            const sel = document.getElementById('rwySelect'); sel.innerHTML = '';
            (stationData.runways||[]).forEach(r => { sel.add(new Option(`RWY ${r.ident1}`, r.ident1)); sel.add(new Option(`RWY ${r.ident2}`, r.ident2)); });
            if(stationData.runways?.length) sel.value = stationData.runways[0].ident1;
            drawWindRose(); renderRunwaysComplex();
        }

        function drawWindRose() {
            const cvs = document.getElementById('windRose'); const ctx = cvs.getContext('2d');
            const rwyIdent = document.getElementById('rwySelect').value; 
            ctx.clearRect(0,0,140,140);
            ctx.beginPath(); ctx.arc(70, 70, 60, 0, 2*Math.PI); ctx.strokeStyle = '#555'; ctx.lineWidth = 2; ctx.stroke();
            ctx.fillStyle = '#888'; ctx.font = '10px sans-serif'; ctx.textAlign = 'center'; ctx.fillText('N', 70, 15);
            
            if(rwyIdent) {
                const rwyHdg = parseInt(rwyIdent.replace(/\D/g,'')) * 10;
                ctx.save(); ctx.translate(70, 70); ctx.rotate((rwyHdg-90)*(Math.PI/180));
                ctx.fillStyle = '#333'; ctx.fillRect(-45, -6, 90, 12); ctx.strokeStyle = '#fff'; ctx.lineWidth = 1; ctx.strokeRect(-45, -6, 90, 12);
                ctx.restore();
                
                const windMag = currentWind.dir - (stationData.magnetic_variation||0);
                const diff = (windMag - rwyHdg) * (Math.PI/180);
                const hw = Math.round(Math.cos(diff) * currentWind.spd);
                const xw = Math.round(Math.sin(diff) * currentWind.spd);
                
                const vHW = document.getElementById('valHW'); 
                vHW.innerText = hw >= 0 ? `${hw}kt Head` : `${Math.abs(hw)}kt Tail`; 
                vHW.style.color = hw < 0 ? 'var(--danger)' : 'var(--success)';
                document.getElementById('valXW').innerText = `${Math.abs(xw)}kt ${xw >= 0 ? 'L' : 'R'}`;
                
                checkMins();
            }
            if(currentWind.spd > 0) {
                const windRad = (currentWind.dir - (stationData.magnetic_variation||0) - 90) * (Math.PI/180);
                ctx.save(); ctx.translate(70, 70); ctx.rotate(windRad);
                ctx.beginPath(); ctx.moveTo(55, 0); ctx.lineTo(10, 0); ctx.strokeStyle = '#0a84ff'; ctx.lineWidth = 3; ctx.stroke();
                ctx.beginPath(); ctx.moveTo(70, 0); ctx.lineTo(55, -5); ctx.lineTo(55, 5); ctx.fillStyle = '#0a84ff'; ctx.fill(); 
                ctx.restore();
            }
        }

        function renderRunwaysComplex() {
            const container = document.getElementById('runwayListComplex'); container.innerHTML = '';
            (stationData.runways||[]).forEach(r => {
                const rwyHdg = parseInt(r.ident1.replace(/\D/g,'')) * 10;
                const windMag = currentWind.dir - (stationData.magnetic_variation||0);
                const diff = (windMag - rwyHdg) * (Math.PI/180);
                const hw = Math.round(Math.cos(diff) * currentWind.spd); const xw = Math.round(Math.sin(diff) * currentWind.spd);
                const c1 = hw >= 0 ? 'var(--success)' : 'var(--danger)'; const c2 = hw < 0 ? 'var(--success)' : 'var(--danger)';
                const d = document.createElement('div'); d.className = 'rwy-complex';
                d.innerHTML = `
                    <div class="rc-header"><div class="rc-idents"><span style="color:${c1}">${r.ident1}</span> / <span style="color:${c2}">${r.ident2}</span></div><div class="rc-dims">${Math.round(r.length_ft*0.3048)}m</div></div>
                    <div class="rc-strip">
                        <div class="rc-id-v">${r.ident1}</div>
                        <div class="rc-data">
                            <div class="wind-comp"><span>${Math.abs(hw)}kt</span><span style="color:${c1}">${hw>=0?'‚¨Ü':'‚¨á'}</span></div>
                            <div class="wind-comp"><span>${Math.abs(xw)}kt</span><span style="color:#0a84ff">${xw>=0?'‚¨Ö':'‚û°'}</span></div>
                        </div>
                        <div class="rc-id-v" style="transform:rotate(0deg);">${r.ident2}</div>
                    </div>`;
                container.appendChild(d);
            });
        }

        function renderTaf(d) {
            document.getElementById('rawTaf').innerText = d.raw || "No TAF";
            tafDataCache = d.forecast; 
            const bar = document.getElementById('tafBar'); bar.innerHTML = ''; 
            const axis = document.getElementById('tafAxis'); axis.innerHTML = '';
            if(!d.forecast) return;
            d.forecast.forEach((f, i) => {
                const b = document.createElement('div'); b.className = 'taf-block'; b.style.flex = "1";
                b.style.backgroundColor = f.flight_rules==='VFR'?'var(--success)':f.flight_rules==='MVFR'?'var(--mvfr)':'var(--danger)';
                b.innerText = f.type; b.onclick = () => showTafDetail(i, b.style.backgroundColor);
                bar.appendChild(b);
                if(i%2===0) { const l = document.createElement('div'); l.style.flex="2"; l.style.fontSize="10px"; l.style.color="#666"; l.innerText = `${new Date(f.start_time.dt).getUTCHours()}z`; axis.appendChild(l); }
            });
        }

        function showTafDetail(i, col) {
            const f = tafDataCache[i]; const c = document.getElementById('tafDetail');
            c.classList.remove('hidden'); c.style.borderLeftColor = col;
            document.getElementById('tdTime').innerText = `${new Date(f.start_time.dt).getUTCHours()}z -> ${new Date(f.end_time.dt).getUTCHours()}z`;
            document.getElementById('tdType').innerText = f.type;
            document.getElementById('tdWind').innerText = `${f.wind_direction?.value}¬∞ / ${f.wind_speed?.value}kt`;
            document.getElementById('tdVis').innerText = f.visibility ? f.visibility.value : 'P6SM';
            document.getElementById('tdWx').innerText = f.wx_codes?.map(x=>x.repr).join(' ') || 'NSW';
            document.getElementById('tdCloud').innerText = f.clouds?.map(c=>c.type+c.altitude).join(' ') || 'SKC';
        }

        function checkMins() {
            const xw = parseFloat(document.getElementById('minXW').value);
            const cl = parseFloat(document.getElementById('minCeil').value);
            const res = document.getElementById('minsResult'); const card = document.getElementById('minsCard');
            if(isNaN(xw) || isNaN(cl)) { res.innerText = "SET LIMITS"; res.style.background="#333"; card.style.borderLeftColor="#555"; document.getElementById('minBanner').classList.add('hidden'); return; }
            localStorage.setItem('efb_min_xw', xw); localStorage.setItem('efb_min_ceil', cl);
            
            if(!currentMetar) return;
            const rwyIdent = document.getElementById('rwySelect').value;
            let actXW = 0;
            if(rwyIdent) {
                const diff = (currentWind.dir - (stationData.magnetic_variation||0) - parseInt(rwyIdent.replace(/\D/g,''))*10) * (Math.PI/180);
                actXW = Math.abs(Math.sin(diff) * currentWind.spd);
            }
            let actCl = 9999; 
            if(lastMetarObj?.clouds) { const l = lastMetarObj.clouds.find(c => ['BKN','OVC','VV'].includes(c.type)); if(l) actCl = l.altitude*100; }

            if(actXW > xw || actCl < cl) {
                res.innerText = "NO-GO ‚õî"; res.style.background="var(--danger)"; card.style.borderLeftColor="var(--danger)";
                document.getElementById('minBanner').innerText = `‚ö†Ô∏è NO-GO: ${actXW>xw?'X-WIND':'CEILING'} LIMIT`;
                document.getElementById('minBanner').classList.remove('hidden');
            } else {
                res.innerText = "GO ‚úÖ"; res.style.background="var(--success)"; card.style.borderLeftColor="var(--success)";
                document.getElementById('minBanner').classList.add('hidden');
            }
        }

        function calcE6B() {
            const alt = parseFloat(document.getElementById('e6bAlt').value)||0;
            const qnh = parseFloat(document.getElementById('e6bQnh').value)||1013;
            const temp = parseFloat(document.getElementById('e6bTemp').value)||15;
            const ias = parseFloat(document.getElementById('e6bIas').value)||0;
            const pa = alt + (1013 - qnh)*30;
            const da = pa + 120 * (temp - (15 - (2*pa/1000)));
            document.getElementById('resDA').innerText = Math.round(da) + " ft";
            document.getElementById('resTAS').innerText = Math.round(ias * (1 + (alt/1000 * 0.02))) + " kts";
        }

        function formatRawMetar(t) {
            return t.replace(/(G\d{2,3}KT)/g, '<span style="color:var(--danger);">$1</span>')
                    .replace(/(VV\d{3}|OVC00[0-4])/g, '<span style="color:var(--danger);">$1</span>')
                    .replace(/(\s)(\+?\w*TS\w*)(\s|$)/g, '$1<span style="color:var(--warn);">$2</span>$3');
        }

        function formatNotamText(t) {
            return t.replace(/\b(CLSD|CLOSED|U\/S)\b/g, '<span class="n-crit">$1</span>')
                    .replace(/\b(RWY|TWY)\b/g, '<span class="n-bold">$1</span>');
        }

        function toggleNightMode() {
            document.body.classList.toggle('cockpit-dark');
            const isDark = document.body.classList.contains('cockpit-dark');
            localStorage.setItem('efb_night_mode', isDark);
            document.getElementById('btnNightMode').innerHTML = isDark ? "<span>‚ö™ Day Mode</span>" : "<span>üî¥ Cockpit Night Mode</span>";
            if(document.getElementById('rwySelect').value) drawWindRose();
        }

        function checkNightModeSaved() { if(localStorage.getItem('efb_night_mode') === 'true') toggleNightMode(); }

        function setTab(name) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-'+name).classList.add('active');
            document.querySelectorAll('.tab').forEach(t => { if(t.getAttribute('onclick').includes(name)) t.classList.add('active'); });
            if(name === 'world') updateClock();
            if(name === 'taf' && meteoDataCache) setTimeout(() => drawMeteogram(meteoDataCache), 50);
        }

        function updateHeaderCat(s, c) { const b = document.getElementById('headerCat'); b.innerText = s; b.className = 'badge badge-cat ' + c; }
        function toggleClearBtn() { document.getElementById('clearBtn').style.display = document.getElementById('icao').value ? 'block' : 'none'; }
        function clearSearch() { document.getElementById('icao').value = ''; document.getElementById('icao').focus(); toggleClearBtn(); }

        initApp();
    </script>
</body>
</html>
