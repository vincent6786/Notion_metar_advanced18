<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>METAR PLUS Pro</title>
    <meta name="apple-mobile-web-app-title" content="METAR PLUS">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/vincent6786/Notion_metar_advanced/main/app-icon.png">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/vincent6786/Notion_metar_advanced/main/app-icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        /* --- 1. CORE THEME & LAYOUT --- */
        :root {
            --bg: #000000; --card-bg: #1c1c1e; --text: #ffffff; --sub-text: #8e8e93;
            --border: #38383a; --accent: #0a84ff; 
            --danger: #ff453a; --warn: #ff9f0a; --success: #32d74b;
            --mvfr: #0a84ff; --lifr: #bf5af2;
            --sky-bg: #131d2e;
            --strip-bg: #3a3a3c;
        }
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, sans-serif;
            background-color: var(--bg); color: var(--text);
            margin: 0; padding: 12px; font-size: 14px; line-height: 1.4;
            display: flex; flex-direction: column; gap: 12px;
            padding-bottom: max(20px, env(safe-area-inset-bottom)); 
            padding-top: max(12px, env(safe-area-inset-top));
            overscroll-behavior-y: none;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- 2. ANIMATIONS --- */
        @keyframes slideUpFade {
            0% { opacity: 0; transform: translateY(20px) scale(0.98); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        .view-section.active > * { animation: slideUpFade 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) both; }

        /* --- 3. LIQUID GLASS MODE (iOS Home Screen Only) --- */
        @media all and (display-mode: standalone) {
            body {
                background: linear-gradient(160deg, #1a1a2e 0%, #000000 100%);
                background-attachment: fixed;
            }
            .metar-card, .info-card, .freq-card, .clock-card, .search-box, .wind-vis-container, .taf-detail-card, .fr-bar-container, .atc-btn, .nearby-btn, .tabs, .sky-section, .meteogram-container, .quick-chip {
                background: rgba(35, 35, 40, 0.65) !important;
                backdrop-filter: blur(25px);
                -webkit-backdrop-filter: blur(25px);
                border: 1px solid rgba(255, 255, 255, 0.08);
                box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            }
            .search-box { background: rgba(60, 60, 65, 0.5) !important; }
            .tabs {
                background: rgba(0, 0, 0, 0.3) !important;
                border-radius: 12px;
                margin-top: 4px;
                padding: 4px;
                border: 1px solid rgba(255,255,255,0.05);
            }
            .tab.active { color: #fff; text-shadow: 0 0 10px rgba(10, 132, 255, 0.8); }
        }

        /* --- 4. FEATURE: COCKPIT NIGHT MODE --- */
        body.cockpit-dark {
            --bg: #000000 !important; --card-bg: #000000 !important;
            --text: #ff3333 !important; --sub-text: #881111 !important;
            --border: #550000 !important; --accent: #ff0000 !important;
            --success: #ff0000 !important; --warn: #cc3300 !important;
            --danger: #ff0000 !important; --mvfr: #aa0000 !important;
            --lifr: #770000 !important; --sky-bg: #000000 !important;
            --strip-bg: #220000 !important;
        }
        body.cockpit-dark * {
            backdrop-filter: none !important; box-shadow: none !important;
            text-shadow: none !important; border-color: #440000 !important;
        }
        body.cockpit-dark .sky-section, body.cockpit-dark canvas, 
        body.cockpit-dark .icon-btn, body.cockpit-dark .fr-track-modern, 
        body.cockpit-dark .taf-sky-strip, body.cockpit-dark .meteogram-container, 
        body.cockpit-dark .quick-chip {
            filter: grayscale(100%) sepia(100%) saturate(1000%) hue-rotate(-50deg) contrast(1.5);
        }
        body.cockpit-dark .badge-cat { color: #000 !important; background: #ff0000 !important; font-weight: 900; }
        body.cockpit-dark .tab.active { border-bottom-color: #ff0000; color: #ff0000; }
        body.cockpit-dark input, body.cockpit-dark select { background: #110000 !important; color: #ff3333 !important; }
        
        /* NOTAM HIGHLIGHTER STYLES */
        .n-crit { color: #ff453a; font-weight: 800; background: rgba(255, 69, 58, 0.15); padding: 0 4px; border-radius: 3px; }
        .n-warn { color: #ff9f0a; font-weight: 700; }
        .n-bold { color: #ffffff; font-weight: 700; text-decoration: underline; text-decoration-color: #555; }
        body.cockpit-dark .n-crit { color: #ff0000; background: #330000; }
        body.cockpit-dark .n-warn { color: #cc3300; }
        body.cockpit-dark .n-bold { color: #ff3333; }

        /* --- 5. UI ELEMENTS --- */
        .top-bar { display: flex; align-items: center; gap: 8px; height: 40px; }
        .search-wrapper { flex-grow: 1; position: relative; display: flex; align-items: center; }
        .search-box {
            width: 100%; background: var(--card-bg); border-radius: 8px; 
            display: flex; align-items: center; border: 1px solid var(--border);
            padding-left: 8px; transition: border-color 0.2s;
        }
        .search-box:focus-within { border-color: var(--accent); }
        #icao {
            flex-grow: 1; background: transparent; border: none; color: inherit; 
            padding: 8px 4px; text-transform: uppercase; font-weight: 700; 
            font-size: 16px; outline: none; width: 100%;
        }
        .clear-btn { color: var(--sub-text); cursor: pointer; padding: 0 8px; font-size: 14px; display: none; }
        .icon-btn { 
            background: var(--card-bg); border: 1px solid var(--border); color: var(--accent); 
            width: 40px; height: 100%; border-radius: 8px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; text-decoration: none; font-size: 18px;
        }
        .badge { height: 100%; display: flex; align-items: center; justify-content: center; padding: 0 12px; border-radius: 8px; font-weight: 700; font-size: 15px; min-width: 60px; }
        .badge-time { background: var(--card-bg); border: 1px solid var(--border); color: var(--text); font-family: 'SF Mono', monospace; letter-spacing: -0.5px; }
        .badge-cat { background: var(--card-bg); color: var(--sub-text); transition: background 0.3s, color 0.3s; }
        .cat-vfr { background-color: var(--success) !important; color: #000 !important; }
        .cat-mvfr { background-color: var(--mvfr) !important; color: #fff !important; }
        .cat-ifr { background-color: var(--danger) !important; color: #fff !important; }
        .cat-lifr { background-color: var(--lifr) !important; color: #fff !important; }

        .tabs { display: flex; border-bottom: 1px solid var(--border); gap: 15px; padding: 0 4px; overflow-x: auto; scrollbar-width: none; }
        .tab { padding: 10px 0; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--sub-text); border-bottom: 2px solid transparent; text-transform: uppercase; white-space: nowrap; }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

        .view-section { display: none; }
        .view-section.active { display: block; }
        .hidden { display: none !important; }
        .section-title { font-weight:700; color:var(--sub-text); margin: 20px 0 8px 0; font-size:12px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .raw-text { 
            font-family: 'SF Mono', monospace; font-size: 13px; color: #d0d0d0; 
            margin-top: 6px; line-height: 1.4; white-space: pre-wrap; word-break: break-word; 
            background: rgba(255,255,255,0.05); padding: 8px; border-radius: 6px; 
        }

        /* --- QUICK SELECT --- */
        .quick-select-row {
            display: flex; gap: 8px; margin-bottom: 8px; overflow-x: auto; scrollbar-width: none;
        }
        .quick-chip {
            background: var(--card-bg); border: 1px solid var(--border); color: var(--text);
            padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer;
            white-space: nowrap; transition: background 0.2s;
        }
        .quick-chip:active { background: var(--accent); color: #fff; border-color: var(--accent); }

        /* --- METAR GRID & VISUALS --- */
        .metar-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .metar-card { background: var(--card-bg); border-radius: 8px; padding: 10px; display: flex; flex-direction: column; justify-content: center; }
        .metar-card.full-width { grid-column: span 2; }
        .m-label { font-size: 11px; color: var(--sub-text); font-weight: 600; text-transform: uppercase; margin-bottom: 4px; }
        .m-value { font-size: 16px; font-weight: 600; color: var(--text); }
        .m-sub { font-size: 12px; color: var(--sub-text); font-weight: 400; margin-left: 4px;}
        .metar-footer { display: flex; justify-content: space-between; margin-top: 8px; padding: 0 4px; font-size: 12px; color: var(--sub-text); }
        
        /* Sky Section */
        .sky-section {
            grid-column: span 2; background: var(--sky-bg); border-radius: 12px; padding: 16px; position: relative; overflow: hidden;
        }
        .sky-header { font-size: 11px; color: rgba(255,255,255,0.4); font-weight: 700; margin-bottom: 12px; text-transform: uppercase; }
        .sky-layer { display: flex; flex-direction: column; margin-bottom: 14px; }
        .sky-icons-row { display: flex; gap: 12px; margin-bottom: 4px; align-items: flex-end; }
        .sky-icon { width: 32px; height: 20px; fill: #d1d5db; opacity: 0.9; }
        .sky-layer-text { font-size: 15px; font-weight: 500; color: #fff; }
        .sky-no-data { text-align: center; color: rgba(255,255,255,0.3); padding: 20px; font-style: italic; }

        /* --- FLIGHT RULE GAUGES --- */
        .fr-bar-container { grid-column: span 2; background: var(--card-bg); padding: 12px; border-radius: 8px; margin-top: 4px; }
        .fr-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .fr-title { font-size: 11px; color: var(--sub-text); font-weight: 700; text-transform: uppercase; }
        
        .fr-gauge-group { display: flex; flex-direction: column; gap: 14px; }
        .fr-row-label { display: flex; justify-content: space-between; font-size: 11px; font-weight: 700; color: var(--sub-text); margin-bottom: 6px; text-transform: uppercase; }
        .fr-val-text { color: var(--text); font-family: 'SF Mono', monospace; font-size: 12px; }

        /* The Background Track (Ruler) */
        .fr-track-modern { position: relative; height: 10px; background: #333; border-radius: 5px; overflow: hidden; display: flex; }
        .fr-sec { height: 100%; border-right: 1px solid rgba(0,0,0,0.3); position: relative; background: rgba(255,255,255,0.02); }
        .fr-sec span { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 7px; color: rgba(255,255,255,0.2); font-weight: 800; pointer-events: none; z-index: 1; letter-spacing: 0.5px; }

        /* The Colored Fill Bar */
        .fr-fill-bar { position: absolute; top: 0; left: 0; bottom: 0; background: var(--accent); border-right: 2px solid #fff; box-shadow: 2px 0 8px rgba(0,0,0,0.5); transition: width 1s cubic-bezier(0.1, 1.2, 0.3, 1), background-color 0.3s; z-index: 2; opacity: 0.9; border-radius: 5px 0 0 5px; }

        .fr-msg { margin-top: 12px; font-size: 13px; color: var(--text); font-weight: 500; border-top: 1px solid var(--border); padding-top: 8px; }

        /* --- METEOGRAM STYLES --- */
        .meteogram-container {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 8px;
            position: relative;
            border: 1px solid var(--border);
            overflow-x: auto; 
        }
        #meteoCanvas {
            width: 100%;
            height: 150px;
            display: block;
        }

        /* Wind & Vis */
        .wind-vis-container { background: var(--card-bg); border-radius: 8px; padding: 12px; margin-top: 12px; display: flex; gap: 15px; align-items: center; }
        .wind-controls { flex-grow: 1; display: flex; flex-direction: column; gap: 8px; }
        .wind-stats { font-family: 'SF Mono', monospace; font-size: 13px; color: var(--text); margin-top: 5px; }
        .stat-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #333; }
        select.stealth-select { background: #2c2c2e; border: 1px solid var(--border); color: #fff; padding: 6px; border-radius: 6px; width: 100%; font-weight: 600; outline: none; }

        /* TAF */
        .taf-viz-container { margin-top: 10px; position: relative; }
        .taf-bar { display: flex; height: 32px; width: 100%; background: #2c2c2e; border-radius: 6px; overflow: hidden; border: 1px solid var(--border); position: relative; z-index: 2; }
        .taf-sky-strip { height: 6px; width: 100%; margin-top: 2px; border-radius: 3px; background: #333; overflow: hidden; position: relative; }
        .taf-axis { display: flex; width: 100%; margin-top: 4px; margin-bottom: 12px; }
        .taf-block { cursor: pointer; position: relative; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 800; color: rgba(0,0,0,0.6); border-right: 1px solid rgba(0,0,0,0.1); transition: opacity 0.2s; text-transform: uppercase; }
        .taf-block:hover { opacity: 0.8; }
        .taf-detail-card { position: relative; z-index: 10; background: var(--card-bg); border-radius: 8px; padding: 16px; border-left: 4px solid var(--sub-text); animation: slideUpFade 0.2s ease-out; }
        #tafNeedle { position: absolute; top: -4px; height: 40px; width: 2px; background: #ff453a; z-index: 5; pointer-events: none; box-shadow: 0 0 8px #ff453a; transition: left 0.5s ease-out; display: none; }
        #tafNeedle::after { content: ''; position: absolute; top: -4px; left: -4px; width: 10px; height: 10px; background: #ff453a; border-radius: 50%; border: 2px solid #000; }

        /* Runways & Buttons */
        .rwy-complex { margin-bottom: 16px; }
        .rc-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 4px; padding: 0 4px; }
        .rc-idents { font-size: 16px; font-weight: 800; font-family: 'SF Mono', monospace; }
        .rc-strip { height: 44px; background: var(--strip-bg); border-radius: 8px; display: flex; align-items: center; justify-content: space-between; padding: 0 6px; overflow: hidden; position: relative; }
        .rc-id-v { font-size: 12px; font-weight: 700; color: #fff; writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); padding: 0 4px; }
        .rc-data { flex-grow: 1; display: flex; align-items: center; justify-content: center; gap: 12px; }
        .wind-comp { display: flex; align-items: center; gap: 2px; font-size: 14px; font-weight: 600; color: #fff; }
        
        .atc-btn { display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); padding: 14px 16px; border-radius: 10px; text-decoration: none; color: var(--text); font-weight: 600; font-size: 15px; border: 1px solid var(--border); transition: background 0.2s; margin-bottom: 10px; }
        .atc-btn:hover { background: #2c2c2e; border-color: var(--accent); }
        .tool-btn { background: #333; border: 1px solid var(--border); color: #fff; width: 100%; padding: 8px; border-radius: 6px; cursor: pointer; margin-top: 4px; font-weight: 600; }
        
        /* Nearby */
        .nearby-container { grid-column: span 2; display: flex; flex-direction: column; gap: 4px; margin-top: 8px; }
        .nearby-header { font-size: 11px; color: var(--sub-text); font-weight: 700; }
        .nearby-list { display: flex; gap: 6px; flex-wrap: wrap; }
        .nearby-btn { background: #2c2c2e; border: 1px solid var(--border); color: #fff; padding: 6px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px; }

        /* Clock & Misc Info */
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
        .info-card { background: var(--card-bg); padding: 10px; border-radius: 8px; }
        .ic-lbl { font-size: 11px; color: var(--sub-text); text-transform: uppercase; }
        .ic-val { font-size: 15px; font-weight: 600; color: var(--text); margin-top: 2px; }
        .freq-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 8px; }
        .freq-card { background: var(--card-bg); border-radius: 8px; padding: 10px; text-align: center; }
        .freq-type { font-size: 11px; color: var(--sub-text); text-transform: uppercase; margin-bottom: 4px; }
        .freq-val { font-size: 16px; font-weight: 700; color: var(--accent); font-family: 'SF Mono', monospace; }
        .clock-card { background: var(--card-bg); border-radius: 8px; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #2c2c2e; margin-bottom: 8px; }
        .clock-time { font-family: 'SF Mono', monospace; font-size: 28px; font-weight: 400; color: var(--text); letter-spacing: 0.5px; }

        /* Conv Inputs */
        .conv-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .conv-lbl { font-size: 10px; color: var(--sub-text); margin-bottom: 4px; text-transform: uppercase; }
        .conv-inp { width: 100%; background: #333; border: 1px solid #555; color: #fff; padding: 8px; border-radius: 6px; font-size: 16px; font-weight: 600; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="search-wrapper">
            <div class="search-box">
                <span style="padding-left:4px">üîç</span>
                <input type="text" id="icao" 
                       placeholder="Search (e.g. KJFK)" 
                       onkeydown="if(event.key==='Enter') loadData()" 
                       oninput="toggleClearBtn()"
                       autocapitalize="characters" 
                       autocomplete="off" 
                       autocorrect="off" 
                       spellcheck="false">
                <span id="clearBtn" class="clear-btn" onclick="clearSearch()">‚úñ</span>
            </div>
        </div>
        <button class="icon-btn" onclick="loadData()" title="Force Refresh">‚Üª</button>
        
        <div id="headerCat" class="badge badge-cat">--</div>
        <div id="zuluTime" class="badge badge-time">--:--Z</div>
        <a id="linkSkyVector" href="#" target="_blank" class="icon-btn" title="Charts">üó∫Ô∏è</a>
    </div>

    <div class="quick-select-row">
        <div class="quick-chip" onclick="quickLoad('RCTP')">RCTP</div>
        <div class="quick-chip" onclick="quickLoad('RCSS')">RCSS</div>
        <div class="quick-chip" onclick="quickLoad('KSFO')">KSFO</div>
        <div class="quick-chip" onclick="quickLoad('KMHR')">KMHR</div>
        <div class="quick-chip" onclick="quickLoad('RJAA')">RJAA</div>
    </div>

    <div id="minBanner" class="hidden" style="padding: 8px; text-align: center; font-weight: 800; font-size: 14px; margin-bottom: 8px; border-radius: 6px; cursor: pointer; background: var(--danger);" onclick="setTab('tools')">
        ‚ö†Ô∏è NO-GO CHECK TOOLS
    </div>

    <div class="tabs">
        <div class="tab active" onclick="setTab('metar')">METAR</div>
        <div class="tab" onclick="setTab('taf')">TAF</div>
        <div class="tab" onclick="setTab('info')">INFO</div>
        <div class="tab" onclick="setTab('atc')">ATC</div>
        <div class="tab" onclick="setTab('world')">WORLD</div>
        <div class="tab" onclick="setTab('tools')">TOOLS</div>
        <div class="tab" onclick="setTab('settings')">SETTINGS</div>
    </div>

    <div id="tab-metar" class="view-section active">
        
        <div class="wind-vis-container">
            <canvas id="windRose" width="140" height="140" style="width:140px; height:140px;"></canvas>
            <div class="wind-controls">
                <div class="m-label">Selected Runway</div>
                <select id="rwySelect" class="stealth-select" onchange="drawWindRose()">
                    <option value="">Loading...</option>
                </select>
                <div class="wind-stats">
                    <div class="stat-row"><span class="info-label">Headwind</span> <span id="valHW">--</span></div>
                    <div class="stat-row"><span class="info-label">Crosswind</span> <span id="valXW">--</span></div>
                </div>
            </div>
        </div>

        <div class="metar-grid">
            
            <div id="skyVisuals" class="sky-section">
                <div class="sky-header">Sky Cover (AGL)</div>
                <div id="skyLayersContainer">
                    <div class="sky-no-data">Scanning Sky...</div>
                </div>
            </div>

            <div class="fr-bar-container">
                <div class="fr-header-row">
                    <div class="fr-title">Flight Category Breakdown</div>
                </div>
                
                <div class="fr-gauge-group">
                    <div>
                        <div class="fr-row-label">
                            <span>Ceiling</span>
                            <span id="labelCeilVal" class="fr-val-text">--</span>
                        </div>
                        <div class="fr-track-modern">
                            <div class="fr-sec" style="width: 25%"><span>LIFR</span></div> 
                            <div class="fr-sec" style="width: 25%"><span>IFR</span></div>  
                            <div class="fr-sec" style="width: 25%"><span>MVFR</span></div> 
                            <div class="fr-sec" style="width: 25%; border:none;"><span>VFR</span></div>  
                            <div id="gaugeCeil" class="fr-fill-bar" style="width: 0%;"></div>
                        </div>
                    </div>

                    <div>
                        <div class="fr-row-label">
                            <span>Visibility</span>
                            <span id="labelVisVal" class="fr-val-text">--</span>
                        </div>
                        <div class="fr-track-modern">
                            <div class="fr-sec" style="width: 25%"><span>LIFR</span></div>
                            <div class="fr-sec" style="width: 25%"><span>IFR</span></div>
                            <div class="fr-sec" style="width: 25%"><span>MVFR</span></div>
                            <div class="fr-sec" style="width: 25%; border:none;"><span>VFR</span></div>
                            <div id="gaugeVis" class="fr-fill-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>
                <div id="frMessage" class="fr-msg">--</div>
            </div>
            
            <div class="metar-card"><div class="m-label">WIND</div><div class="m-value" id="mWind">--</div></div>
            <div class="metar-card"><div class="m-label">VISIBILITY</div><div class="m-value" id="mVis">--</div></div>
            <div class="metar-card"><div class="m-label">CEILING</div><div class="m-value" id="mCeil">--</div></div>
            <div class="metar-card"><div class="m-label">ALTIMETER</div><div class="m-value" id="mAlt">--</div></div>
            <div class="metar-card full-width"><div class="m-label">TEMP / DEWPOINT</div><div class="m-value"><span id="mTempC">--</span> <span id="mTempF" class="m-sub">--</span></div></div>
        </div>

        <div class="raw-text" id="rawMetar">Select an airport above.</div>
        <div class="metar-footer"><span id="mAge">--</span><span id="mSpread">Spread: --</span></div>
        
        <div id="nearbyContainer" class="nearby-container">
            <div class="nearby-header">NEARBY STATIONS</div>
            <div id="nearList" class="nearby-list">
                <span style="color:var(--sub-text); font-size:12px;">--</span>
            </div>
        </div>
    </div>

    <div id="tab-taf" class="view-section">
        <div style="display:flex; justify-content:space-between; align-items:center; color:var(--sub-text); font-size:12px; margin-bottom:8px;">
            <span>24H Trend (Open-Meteo)</span>
            <span style="background:var(--warn); color:#000; padding:2px 6px; border-radius:4px; font-weight:800; font-size:10px;">‚ö†Ô∏è ADVISORY</span>
        </div>
        <div class="meteogram-container">
            <canvas id="meteoCanvas" height="150"></canvas>
            <div id="meteoLoading" class="sky-no-data" style="position:absolute; top:50%; left:0; right:0; text-align:center;">Select Airport</div>
        </div>
        <div style="display:flex; justify-content:space-between; color:var(--sub-text); font-size:12px; margin-bottom:8px; margin-top:20px; border-top:1px solid #333; padding-top:15px;">
            <span>Official Forecast Visualization</span><span id="tafIssued">--</span>
        </div>
        <div class="taf-viz-container">
            <div id="tafNeedle"></div>
            <div id="tafBar" class="taf-bar"></div>
            <div id="tafSkyStrip" class="taf-sky-strip"></div>
            <div id="tafAxis" class="taf-axis"></div>
            <div id="tafDetail" class="taf-detail-card hidden">
                <div class="td-header" style="display:flex; justify-content:space-between; margin-bottom:12px;"><span id="tdTime" style="font-weight:700;">--</span><span id="tdType" style="background:#444; padding:2px 6px; border-radius:4px; color:#fff;">--</span></div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <div><span class="m-label">WIND</span><div id="tdWind" style="font-weight:600;">--</div></div>
                    <div><span class="m-label">VISIBILITY</span><div id="tdVis" style="font-weight:600;">--</div></div>
                    <div><span class="m-label">WEATHER</span><div id="tdWx" style="font-weight:600;">--</div></div>
                    <div><span class="m-label">CLOUDS</span><div id="tdCloud" style="font-weight:600;">--</div></div>
                </div>
            </div>
        </div>
        <div style="margin-top:20px; font-weight:700; color:var(--sub-text);">Raw TAF</div>
        <div class="raw-text" id="rawTaf">Loading...</div>
        <div style="margin-top:20px; font-weight:700; color:var(--sub-text);">NOTAMs</div>
        <div id="notamList" class="raw-text" style="max-height:300px; overflow-y:auto; font-size:11px; background:transparent; padding:0;">Loading...</div>
    </div>
    
    <div id="tab-info" class="view-section">
        <div style="font-size:20px; font-weight:700; margin-bottom:4px;" id="infoName">Unknown</div>
        <div style="font-size:12px; color:var(--sub-text); margin-bottom:12px;" id="infoLoc">--</div>
        <div class="info-grid">
            <div class="info-card"><div class="ic-lbl">ICAO / IATA</div><div class="ic-val" id="infoCodes">--</div></div>
            <div class="info-card"><div class="ic-lbl">Elevation</div><div class="ic-val" id="infoElev">--</div></div>
            <div class="info-card" style="grid-column: span 2;"><div class="ic-lbl">Coordinates</div><div class="ic-val" style="font-size:13px;" id="infoCoords">--</div></div>
        </div>
        <div class="section-title">ATMOSPHERE & TIME</div>
        <div class="info-grid">
            <div class="info-card"><div class="ic-lbl">Pressure Alt</div><div class="ic-val" id="calcPA">--</div></div>
            <div class="info-card"><div class="ic-lbl">Density Alt</div><div class="ic-val" id="calcDA">--</div></div>
            <div class="info-card"><div class="ic-lbl">ISA Dev</div><div class="ic-val" id="calcISA">--</div></div>
            <div class="info-card"><div class="ic-lbl">Sunrise/Set</div><div class="ic-val" style="font-size:13px;" id="infoSun">--</div></div>
        </div>
        <div class="section-title">RUNWAYS & FREQ</div>
        <div id="freqContainer" class="freq-grid"></div>
        <div class="section-title">RUNWAY WIND COMPONENTS</div>
        <div id="runwayListComplex"></div>
    </div>
    
    <div id="tab-atc" class="view-section">
        <div class="info-card" style="margin-bottom: 20px;">
             <div class="ic-lbl" style="margin-bottom:8px;" id="audioLabel">AUDIO STREAMS</div>
             <div id="audioPlayerTarget">
                 <div style="color:var(--sub-text); font-style:italic; padding:10px; text-align:center;">
                     Select an airport to check for streams.
                 </div>
             </div>
        </div>
        <div class="section-title">EXTERNAL RESOURCES</div>
        <a href="https://metar-taf.com/" target="_blank" class="atc-btn"><span>‚òÅÔ∏è Metar-Taf.com</span><span>‚Üó</span></a>
        <a href="https://beta.twatc.net/" target="_blank" class="atc-btn"><span>üáπüáº Taiwan Virtual ATC</span><span>‚Üó</span></a>
        <a id="btnLiveAtc" href="https://www.liveatc.net/" target="_blank" class="atc-btn"><span>üì° LiveATC.net</span><span>‚Üó</span></a>
    </div>

    <div id="tab-world" class="view-section">
        <div style="display:flex; gap:8px; margin-bottom:12px; background:var(--card-bg); padding:8px; border-radius:8px;">
            <input type="text" id="newCityInput" class="conv-inp" placeholder="City Name (e.g. Paris)..." style="margin:0;">
            <button class="tool-btn" style="width:auto; margin:0;" onclick="addCustomCity()">Add</button>
        </div>
        <div id="worldContainer"></div>
    </div>

    <div id="tab-tools" class="view-section">
        
        <div class="section-title" style="margin-top:0;">Personal Minimums</div>
        <div class="info-card" style="border-left: 4px solid #555;" id="minsCard">
            <div class="conv-row">
                <div style="flex:1">
                    <div class="conv-lbl">Max X-Wind (kt)</div>
                    <input type="number" id="minXW" class="conv-inp" placeholder="e.g. 15" oninput="checkMins()" autocomplete="off">
                </div>
                <div style="flex:1">
                    <div class="conv-lbl">Min Ceiling (ft)</div>
                    <input type="number" id="minCeil" class="conv-inp" placeholder="e.g. 1000" oninput="checkMins()" autocomplete="off">
                </div>
            </div>
            <div id="minsResult" style="margin-top:10px; font-weight:800; font-size:18px; text-align:center; padding:10px; border-radius:6px; background:#333; color:#aaa;">SET LIMITS</div>
        </div>

        <div class="section-title">E6B Flight Computer</div>
        <div class="info-card">
            <div class="conv-row">
                <div style="flex:1"><div class="conv-lbl">Alt (ft)</div><input type="number" id="e6bAlt" class="conv-inp" oninput="calcE6B()"></div>
                <div style="flex:1"><div class="conv-lbl">QNH (hPa)</div><input type="number" id="e6bQnh" class="conv-inp" value="1013" oninput="calcE6B()"></div>
                <div style="flex:1"><div class="conv-lbl">Temp (¬∞C)</div><input type="number" id="e6bTemp" class="conv-inp" oninput="calcE6B()"></div>
            </div>
            <div class="conv-row">
                <div style="flex:1"><div class="conv-lbl">IAS (kts)</div><input type="number" id="e6bIas" class="conv-inp" oninput="calcE6B()"></div>
            </div>
            <div class="info-grid" style="margin-top:10px;">
                <div><div class="ic-lbl">Density Alt</div><div class="ic-val" id="resDA" style="color:var(--accent);">--</div></div>
                <div><div class="ic-lbl">TAS</div><div class="ic-val" id="resTAS" style="color:var(--success);">--</div></div>
            </div>
        </div>
    </div>

    <div id="tab-settings" class="view-section">
        <div class="section-title" style="margin-top:0;">Startup Preferences</div>
        
        <div class="info-card">
            <div class="conv-lbl">Default Airport (ICAO)</div>
            <div class="conv-row" style="margin-bottom:0;">
                <input type="text" id="defaultIcaoInput" class="conv-inp" placeholder="e.g. RCTP" style="text-transform:uppercase;" maxlength="4">
                <button class="tool-btn" style="width:auto; margin:0;" onclick="saveDefaultStation()">Save</button>
            </div>
            <div id="saveMsg" style="font-size:12px; color:var(--success); margin-top:8px; height:14px;"></div>
        </div>
    
        <div class="section-title">Visuals</div>
        <button id="btnNightMode" class="atc-btn" onclick="toggleNightMode()" style="justify-content:center; margin-bottom:20px; border:1px solid var(--danger);">
            <span>üî¥ Cockpit Night Mode</span>
        </button>
        
        <div class="section-title">Data & Storage</div>
        <div class="info-card">
            <div style="font-size:12px; color:var(--sub-text); margin-bottom:8px;">
                Clear all saved data (Minimums, Default Airport, Cities).
            </div>
            <button class="tool-btn" style="background:var(--card-bg); border:1px solid var(--danger); color:var(--danger);" onclick="resetApp()">Factory Reset App</button>
        </div>
    </div>

    <script>
        // --- SECURITY WARNING: DO NOT UPLOAD TO PUBLIC REPOS ---
        const AVWX_KEY = '7BVPOe0lM6CvvLCOGwmcmCxTp1n6PgCdcBJ9Lnt3WpI';
        
        let currentWind = { dir:0, spd:0 }; 
        let currentMetar = { temp: 15, alt: 1013, altUnit: 'hPa' };
        let stationData = null;
        let stationSunTimes = null;
        let useMetric = true; 
        let tafDataCache = null;
        let lastMetarObj = null; 
        let meteoDataCache = null;

        // UPDATED: Pre-defined list for World Clock (matches Quick Select)
        const AVIATION_CITIES = [
            {n:"Taipei (TPE)",z:"Asia/Taipei",icao:"RCTP"}, 
            {n:"Songshan (TSA)",z:"Asia/Taipei",icao:"RCSS"}, 
            {n:"San Francisco",z:"America/Los_Angeles",icao:"KSFO"}, 
            {n:"Mather (MHR)",z:"America/Los_Angeles",icao:"KMHR"}, 
            {n:"Narita (NRT)",z:"Asia/Tokyo",icao:"RJAA"}
        ];
        let cityList = [];
        const CLOUD_ICON_PATH = "M25 15C25 10.58 21.42 7 17 7C16.5 7 16 7.05 15.54 7.15C14.73 4.19 12.06 2 9 2C5.13 2 2 5.13 2 9C2 9.17 2 9.35 2.03 9.5C0.84 10.19 0 11.5 0 13C0 15.21 1.79 17 4 17H25C27.76 17 30 14.76 30 12C30 9.24 27.76 7 25 7V15Z";

        // --- INIT ---
        function initApp() {
            initWorldClock();
            checkNightModeSaved();

            // Load Default Station Preference
            const savedDefault = localStorage.getItem('efb_default_station');
            const inputField = document.getElementById('defaultIcaoInput');
            
            if (savedDefault) {
                // Populate the settings input
                inputField.value = savedDefault;
                // Auto-load the station on the main screen
                document.getElementById('icao').value = savedDefault;
                loadData(); 
            } else {
                // No default saved, just clear the box
                document.getElementById('icao').value = "";
            }
            
            // Load Personal Minimums inputs if they exist
            const savedXW = localStorage.getItem('efb_min_xw');
            const savedCeil = localStorage.getItem('efb_min_ceil');
            if(savedXW) document.getElementById('minXW').value = savedXW;
            if(savedCeil) document.getElementById('minCeil').value = savedCeil;

            // Start Clock
            setInterval(updateClock, 1000);
        }

        // --- NEW: QUICK LOAD HANDLER ---
        function quickLoad(code) {
            document.getElementById('icao').value = code;
            loadData();
        }

        function saveDefaultStation() {
            const val = document.getElementById('defaultIcaoInput').value.trim().toUpperCase();
            const msg = document.getElementById('saveMsg');
            
            if(val.length >= 3) {
                localStorage.setItem('efb_default_station', val);
                msg.innerText = "Default station saved! Will load on startup.";
                setTimeout(() => { msg.innerText = ""; }, 3000);
            } else {
                msg.style.color = "var(--warn)";
                msg.innerText = "Invalid ICAO code.";
            }
        }

        function resetApp() {
            if(confirm("Reset all settings and clear local data?")) {
                localStorage.clear();
                location.reload();
            }
        }

        // --- CORE DATA LOADING ---
        async function loadData() {
            const icaoVal = document.getElementById('icao').value;
            if(!icaoVal) return;
            
            const icao = icaoVal.toUpperCase();
            
            // UI Updates
            document.getElementById('icao').blur();
            document.getElementById('linkSkyVector').href = `https://skyvector.com/airport/${icao}`;
            updateHeaderCat('Loading', '');
            
            const rawContainer = document.getElementById('rawMetar');
            rawContainer.innerHTML = 'Loading...';
            document.getElementById('nearList').innerHTML = '<span style="color:#555;">Scanning...</span>';

            const headers = { 'Authorization': `Bearer ${AVWX_KEY}` };
            const cb = Date.now();
            
            try {
                // 1. Station Info
                const stationResp = await fetch(`https://avwx.rest/api/station/${icao}?t=${cb}`, {headers});
                if(!stationResp.ok) throw new Error("Station Not Found");
                stationData = await stationResp.json();
                renderInfo(stationData); 
                
                // NEW: Fetch Meteogram (Knots)
                fetchMeteogram(stationData.latitude, stationData.longitude);

                // 2. Fetch WX
                const [metarRes, tafRes, notamRes] = await Promise.allSettled([
                    fetch(`https://avwx.rest/api/metar/${icao}?t=${cb}`, {headers}).then(r=>r.json()),
                    fetch(`https://avwx.rest/api/taf/${icao}?t=${cb}`, {headers}).then(r=>r.json()),
                    fetch(`https://avwx.rest/api/notam/${icao}?t=${cb}`, {headers}).then(r=>r.json())
                ]);

                if(metarRes.status === 'fulfilled' && !metarRes.value.error) {
                    const m = metarRes.value;
                    lastMetarObj = m;
                    currentWind = { dir: m.wind_direction?.value||0, spd: m.wind_speed?.value||0 };
                    
                    let altVal = m.altimeter?.value || 1013;
                    let altUnit = altVal < 200 ? 'inHg' : 'hPa';
                    currentMetar = { temp: m.temperature?.value || 15, alt: altVal, altUnit: altUnit };
                    
                    renderMetar(m); 
                    renderSkyVisuals(m);
                    renderFlightRuleBar(m); 
                    setupRunwaySelect();
                    findNearbyStations(stationData.latitude, stationData.longitude); 
                    
                    // --- ATC AUDIO UPDATE ---
                    updateAudioSection(icao);
                } else {
                    throw new Error("No Weather Data");
                }

                if(tafRes.status === 'fulfilled') renderTaf(tafRes.value);
                
                if(notamRes.status === 'fulfilled') {
                    const n = notamRes.value;
                    const notamContainer = document.getElementById('notamList');
                    if (Array.isArray(n) && n.length > 0) {
                        n.sort((a, b) => {
                            const crit = /CLSD|CLOSED|U\/S|UNSERVICEABLE/;
                            return crit.test(b.raw) - crit.test(a.raw); 
                        });

                        notamContainer.innerHTML = n.map(x => {
                            const raw = x.raw;
                            let borderCol = 'rgba(255,255,255,0.1)';
                            if (/(CLSD|CLOSED|U\/S)/.test(raw)) borderCol = 'var(--danger)';
                            else if (/(OBST|WORK|WIP)/.test(raw)) borderCol = 'var(--warn)';
                            
                            return `<div style="margin-bottom:8px; border-left:4px solid ${borderCol}; background: rgba(255,255,255,0.03); padding: 8px; border-radius: 0 4px 4px 0;">
                                <div style="font-size:10px; color:#888; margin-bottom:2px;">${x.start_time?.dt ? new Date(x.start_time.dt).toLocaleDateString() : ''} - ${x.end_time?.dt ? new Date(x.end_time.dt).toLocaleDateString() : 'PERM'}</div>
                                ${formatNotamText(raw)}
                            </div>`;
                        }).join('');
                    } else {
                        notamContainer.innerHTML = "No NOTAMs Found";
                    }
                }

            } catch(e) {
                console.error(e);
                updateHeaderCat('N/A', 'cat-ifr');
                const icao = document.getElementById('icao').value.toUpperCase();
                rawContainer.innerHTML = `
                    <div style="text-align:center; padding:20px 10px;">
                        <div style="color:var(--danger); font-weight:800; margin-bottom:15px;">STATION DATA UNAVAILABLE</div>
                        <a href="https://metar-taf.com/${icao}" target="_blank" class="atc-btn" style="justify-content:center; background:var(--accent); border:none; color:#fff;">
                            <span>View on Metar-Taf.com ‚Üó</span>
                        </a>
                    </div>`;
            }
        }

        function updateAudioSection(icao) {
            const container = document.getElementById('audioPlayerTarget');
            const label = document.getElementById('audioLabel');
            const liveAtcBtn = document.getElementById('btnLiveAtc');

            // 1. Update the LiveATC Button Link dynamically
            if (liveAtcBtn) {
                liveAtcBtn.href = `https://www.liveatc.net/search/?icao=${icao}`;
                liveAtcBtn.innerHTML = `<span>üì° LiveATC (${icao})</span><span>‚Üó</span>`;
            }

            // 2. Handle Specific Streams (RCTP)
            if (icao === 'RCTP') {
                label.innerText = "RCTP LIVE STREAMS (TWATC)";
                container.innerHTML = `
                    <div style="margin-bottom:12px;">
                        <div class="m-label" style="color:var(--accent);">ATIS (127.6)</div>
                        <audio controls style="width: 100%; height: 32px; border-radius:16px;">
                            <source src="https://stream.twatc.net/RCTP_ATIS" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio>
                    </div>
                    <div>
                        <div class="m-label" style="color:var(--success);">ATC SCANNER (GND/TWR/APP)</div>
                        <audio controls style="width: 100%; height: 32px; border-radius:16px;">
                            <source src="https://stream.twatc.net/RCTP_Scan2" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio>
                    </div>
                    <div style="font-size:10px; color:#555; margin-top:8px; text-align:right;">Source: TWATC.net</div>
                `;
            } 
            else {
                // Default View for other airports
                label.innerText = "AUDIO STREAMS";
                container.innerHTML = `
                    <div style="color:var(--sub-text); font-size:13px; text-align:center; padding:10px 0;">
                        No direct in-app stream available for ${icao}.<br>
                        <span style="font-size:11px; color:#555;">Use the LiveATC button below to search external feeds.</span>
                    </div>
                `;
            }
        }

        // --- UPDATED: ADVISORY METEOGRAM WITH BIGGER ARROWS ---
        async function fetchMeteogram(lat, lon) {
            const loader = document.getElementById('meteoLoading');
            loader.style.display = 'block';
            
            // Reset cache on new fetch
            meteoDataCache = null; 
        
            try {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,dewpoint_2m,wind_speed_10m,wind_direction_10m,wind_gusts_10m,weather_code&wind_speed_unit=kn&forecast_days=1`;
                const res = await fetch(url);
                const data = await res.json();
                
                if(data.hourly) {
                    // 1. SAVE DATA TO CACHE
                    meteoDataCache = data.hourly; 
                    // 2. Attempt to draw (will work if TAF tab is already open)
                    drawMeteogram(meteoDataCache);
                }
                loader.style.display = 'none';
            } catch(e) {
                console.error("Meteo Error:", e);
                loader.innerText = "Model Data Unavailable";
            }
        }

        function drawMeteogram(h) {
            const cvs = document.getElementById('meteoCanvas');
            const ctx = cvs.getContext('2d');
            
            const dpr = window.devicePixelRatio || 1;
            const rect = cvs.getBoundingClientRect();
            cvs.width = rect.width * dpr;
            cvs.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            
            const W = rect.width;
            const H = rect.height;
            const padding = {top: 40, bottom: 35, left: 15, right: 15};
            
            ctx.clearRect(0,0,W,H);
            
            const len = 24; 
            
            let minT = 100, maxT = -100;
            for(let i=0; i<len; i++) {
                minT = Math.min(minT, h.temperature_2m[i], h.dewpoint_2m[i]);
                maxT = Math.max(maxT, h.temperature_2m[i], h.dewpoint_2m[i]);
            }
            minT -= 2; maxT += 2;
            const rangeT = maxT - minT;
            
            const getX = (i) => padding.left + (i / (len-1)) * (W - padding.left - padding.right);
            const getY = (val) => H - padding.bottom - ((val - minT) / rangeT) * (H - padding.top - padding.bottom);

            function getWxIcon(code) {
                if(code <= 1) return '‚òÄÔ∏è'; 
                if(code <= 3) return '‚õÖ'; 
                if(code <= 48) return 'üå´Ô∏è'; 
                if(code <= 57) return 'üåßÔ∏è'; 
                if(code <= 67) return '‚òî'; 
                if(code <= 77) return '‚ùÑÔ∏è'; 
                if(code <= 82) return '‚õàÔ∏è'; 
                if(code <= 99) return '‚ö°'; 
                return '‚òÅÔ∏è';
            }

            // 1. Vertical Grid
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.08)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            for(let i=0; i<len; i+=3) {
                const x = getX(i);
                ctx.moveTo(x, padding.top);
                ctx.lineTo(x, H - padding.bottom);
            }
            ctx.stroke();

            // 2. Fog Risk Shading
            const stepX = (W - padding.left - padding.right) / (len - 1);
            for(let i=0; i<len-1; i++) {
                const spread = h.temperature_2m[i] - h.dewpoint_2m[i];
                const x = getX(i);
                const yTemp = getY(h.temperature_2m[i]);
                const yDew = getY(h.dewpoint_2m[i]);
                
                ctx.beginPath();
                ctx.moveTo(x, yTemp);
                ctx.lineTo(x + stepX, getY(h.temperature_2m[i+1]));
                ctx.lineTo(x + stepX, getY(h.dewpoint_2m[i+1]));
                ctx.lineTo(x, yDew);
                ctx.closePath();
                ctx.fillStyle = spread < 2.0 ? 'rgba(255, 69, 58, 0.25)' : 'rgba(255, 204, 0, 0.05)';
                ctx.fill();
            }

            // 3. Lines
            function drawLine(dataArr, color, width) {
                ctx.beginPath();
                ctx.strokeStyle = color;
                ctx.lineWidth = width;
                ctx.lineJoin = 'round';
                for(let i=0; i<len; i++) {
                    const x = getX(i);
                    const y = getY(dataArr[i]);
                    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
                }
                ctx.stroke();
            }
            drawLine(h.dewpoint_2m, '#0a84ff', 2);
            drawLine(h.temperature_2m, '#ff453a', 2);

            // 4. Data Points & BIGGER ARROWS
            ctx.textAlign = 'center';
            for(let i=0; i<len; i+=3) {
                const x = getX(i);
                
                // Weather Icon
                const wxCode = h.weather_code ? h.weather_code[i] : 3; 
                ctx.font = '14px sans-serif';
                ctx.fillStyle = '#fff';
                ctx.fillText(getWxIcon(wxCode), x, padding.top - 15);

                // Wind Arrow & Speed
                const windDir = h.wind_direction_10m[i];
                const windSpd = Math.round(h.wind_speed_10m[i]);
                const windGust = Math.round(h.wind_gusts_10m[i]);
                
                // --- BIGGER ARROW LOGIC ---
                ctx.save();
                ctx.translate(x, H - 25);
                ctx.rotate((windDir + 180) * Math.PI / 180); 
                ctx.beginPath();
                // Increased size: (0,-8) instead of (0,-4)
                ctx.moveTo(0, -8); 
                ctx.lineTo(-5, 5); 
                ctx.lineTo(0, 2); 
                ctx.lineTo(5, 5); 
                ctx.closePath();
                ctx.fillStyle = '#0a84ff'; // Cyan/Blue for better visibility
                ctx.fill();
                ctx.restore();
                
                // Speed Text
                ctx.font = '700 11px "SF Mono", monospace';
                ctx.fillStyle = '#fff';
                let spdText = `${windSpd}`;
                if (windGust > windSpd + 5) {
                    spdText += `G${windGust}`;
                    ctx.fillStyle = '#ff9f0a';
                }
                ctx.fillText(spdText, x, H - 10); // Moved slightly down
                
                // Time
                ctx.fillStyle = '#666';
                ctx.font = '10px sans-serif';
                ctx.fillText(`${i}z`, x, H);
            }
        }

        // --- RENDERERS ---
        function renderMetar(d) {
            const rawContainer = document.getElementById('rawMetar');
            const now = new Date();
            const metarTime = new Date(d.time.dt);
            const minAgo = Math.floor((now - metarTime) / 60000);

            rawContainer.innerHTML = formatRawMetar(d.raw);
            
            if (minAgo > 60) {
                rawContainer.insertAdjacentHTML('beforeend', `<div style="margin-top:12px; padding:10px; background:rgba(255, 69, 58, 0.1); border:1px solid var(--danger); border-radius:6px; text-align:center;"><div style="color:var(--danger); font-weight:800; font-size:12px;">‚ö†Ô∏è DATA OUTDATED (${minAgo}m old)</div></div>`);
            }

            const rules = d.flight_rules; 
            let css = 'cat-vfr';
            if(rules==='MVFR') css='cat-mvfr'; if(rules==='IFR') css='cat-ifr'; if(rules==='LIFR') css='cat-lifr';
            updateHeaderCat(rules, css);

            document.getElementById('mWind').innerText = `${currentWind.dir.toString().padStart(3,'0')}¬∞ / ${currentWind.spd}kt`;
            document.getElementById('mVis').innerText = d.visibility ? `${d.visibility.value} sm` : '--';
            const c = d.clouds?.[0]; 
            document.getElementById('mCeil').innerText = c ? `${c.type} ${c.altitude.toString().padStart(3,'0')}` : "CLR";
            
            const alt = d.altimeter?.value; 
            if(alt) {
                if(currentMetar.altUnit === 'hPa') { 
                    const inHg = (alt * 0.02953).toFixed(2); document.getElementById('mAlt').innerText = `Q${alt} / A${inHg}`; 
                } else { 
                    const hPa = Math.round(alt * 33.8639); document.getElementById('mAlt').innerText = `Q${hPa} / A${alt.toFixed(2)}`; 
                }
            }
            const t = d.temperature?.value, dew = d.dewpoint?.value;
            if(t!=null) {
                document.getElementById('mTempC').innerText = `${t}¬∞C / ${dew!=null?dew:'--'}¬∞C`;
                document.getElementById('mTempF').innerText = `(${Math.round(t*1.8+32)}¬∞F)`;
                document.getElementById('mSpread').innerText = `Spread: ${(t-dew).toFixed(1)}¬∞C`;
            }

            const ageEl = document.getElementById('mAge');
            ageEl.innerText = `${minAgo}m ago`;
            if (minAgo > 60) { ageEl.style.color = 'var(--danger)'; ageEl.style.fontWeight = '700'; }
            else { ageEl.style.color = 'var(--sub-text)'; ageEl.style.fontWeight = '400'; }
        }

        function renderSkyVisuals(m) {
            const container = document.getElementById('skyLayersContainer');
            container.innerHTML = '';
            if (!m.clouds || m.clouds.length === 0) { container.innerHTML = '<div class="sky-no-data">Sky Clear (SKC/CLR)</div>'; return; }
            const sortedClouds = [...m.clouds].sort((a,b) => b.altitude - a.altitude);

            sortedClouds.forEach(c => {
                const layer = document.createElement('div'); layer.className = 'sky-layer';
                let count = 0;
                if(c.type === 'FEW') count = 2; else if(c.type === 'SCT') count = 4; else if(c.type === 'BKN') count = 7; else if(c.type === 'OVC' || c.type === 'VV') count = 8;
                let iconsHtml = '';
                for(let i=0; i<count; i++) iconsHtml += `<svg class="sky-icon" viewBox="0 0 30 20"><path d="${CLOUD_ICON_PATH}"/></svg>`;
                const typeName = {'FEW': 'Few', 'SCT': 'Scattered', 'BKN': 'Broken', 'OVC': 'Overcast', 'VV': 'Vert. Vis'}[c.type] || c.type;
                layer.innerHTML = `<div class="sky-icons-row">${iconsHtml}</div><div class="sky-layer-text">${typeName} ${c.altitude * 100}'</div>`;
                container.appendChild(layer);
            });
        }

        // --- DUAL LINEAR GAUGES ---
        function renderFlightRuleBar(m) {
            let ceiling = 99999;
            if (m.clouds && m.clouds.length > 0) {
                const ceilLayer = m.clouds.find(c => c.type === 'BKN' || c.type === 'OVC' || c.type === 'VV');
                if (ceilLayer) ceiling = ceilLayer.altitude * 100;
            }
            let vis = 10;
            if (m.visibility) vis = m.visibility.value;

            function getGaugeStats(val, type) {
                let pct = 0;
                let color = 'var(--success)';
                
                if (type === 'ceil') {
                    // Scale: 0-500 (25%), 500-1000 (25%), 1000-3000 (25%), >3000 (25%)
                    if (val < 500) { pct = (val / 500) * 25; color = 'var(--lifr)'; } 
                    else if (val < 1000) { pct = 25 + ((val - 500) / 500) * 25; color = 'var(--danger)'; } 
                    else if (val < 3000) { pct = 50 + ((val - 1000) / 2000) * 25; color = 'var(--mvfr)'; } 
                    else { pct = 75 + Math.min(1, (val - 3000) / 3000) * 25; color = 'var(--success)'; }
                } 
                if (type === 'vis') {
                    // Scale: 0-1 (25%), 1-3 (25%), 3-5 (25%), >5 (25%)
                    if (val < 1) { pct = (val / 1) * 25; color = 'var(--lifr)'; } 
                    else if (val < 3) { pct = 25 + ((val - 1) / 2) * 25; color = 'var(--danger)'; } 
                    else if (val < 5) { pct = 50 + ((val - 3) / 2) * 25; color = 'var(--mvfr)'; } 
                    else { pct = 100; color = 'var(--success)'; }
                }
                return { width: Math.max(5, pct) + '%', color: color };
            }

            const cStats = getGaugeStats(ceiling, 'ceil');
            const vStats = getGaugeStats(vis, 'vis');

            const ceilBar = document.getElementById('gaugeCeil');
            ceilBar.style.width = cStats.width;
            ceilBar.style.backgroundColor = cStats.color;
            document.getElementById('labelCeilVal').innerText = ceiling === 99999 ? 'Unlimited' : `${ceiling} ft`;
            document.getElementById('labelCeilVal').style.color = cStats.color;

            const visBar = document.getElementById('gaugeVis');
            visBar.style.width = vStats.width;
            visBar.style.backgroundColor = vStats.color;
            document.getElementById('labelVisVal').innerText = `${vis} sm`;
            document.getElementById('labelVisVal').style.color = vStats.color;

            const rule = m.flight_rules;
            const msgEl = document.getElementById('frMessage');
            if (rule === 'VFR') { msgEl.innerText = `Visual Flight Rules (Vis > 5sm & Ceil > 3000')`; msgEl.style.color = 'var(--success)'; }
            else if (rule === 'MVFR') { msgEl.innerText = `Marginal VFR (Ceil 1000-3000' or Vis 3-5sm)`; msgEl.style.color = 'var(--mvfr)'; }
            else if (rule === 'IFR') { msgEl.innerText = `Instrument Flight Rules (Ceil < 1000' or Vis < 3sm)`; msgEl.style.color = 'var(--danger)'; }
            else if (rule === 'LIFR') { msgEl.innerText = `Low IFR (Ceil < 500' or Vis < 1sm)`; msgEl.style.color = 'var(--lifr)'; }
        }

        async function findNearbyStations(lat, lon) {
            try {
                const headers = { 'Authorization': `Bearer ${AVWX_KEY}` };
                const url = `https://avwx.rest/api/station/near/${lat},${lon}?n=5`; 
                const res = await fetch(url, { headers });
                const data = await res.json();
                
                const list = document.getElementById('nearList');
                list.innerHTML = "";
                const currentIcao = document.getElementById('icao').value.toUpperCase();
                const others = data.filter(item => item.station.icao !== currentIcao).slice(0, 4);

                if(others.length === 0) { list.innerHTML = "<span style='color:#555;'>No stations found nearby.</span>"; return; }

                others.forEach(item => {
                    const stn = item.station;
                    const btn = document.createElement('div'); btn.className = "nearby-btn";
                    btn.innerHTML = `<span>‚úà</span><span>${stn.icao}</span><span style="color:var(--sub-text); font-size:10px;">${Math.round(item.nautical_miles)}nm</span>`;
                    btn.onclick = () => { document.getElementById('icao').value = stn.icao; loadData(); };
                    list.appendChild(btn);
                });
            } catch(e) { console.error(e); }
        }

        function renderInfo(d) {
            document.getElementById('infoName').innerText = d.name;
            document.getElementById('infoLoc').innerText = `${d.city || ''}, ${d.country || ''} (${d.icao})`;
            document.getElementById('infoCodes').innerText = `${d.icao} / ${d.iata || '--'}`;
            document.getElementById('infoElev').innerText = `${d.elevation_ft} ft`;
            document.getElementById('infoCoords').innerText = `${d.latitude.toFixed(4)}, ${d.longitude.toFixed(4)}`;

            const elev = d.elevation_ft; 
            const temp = currentMetar.temp;
            let qnhHpa = currentMetar.alt;
            if(currentMetar.altUnit === 'inHg') qnhHpa = currentMetar.alt * 33.8639;
            
            // Standard Aviation Calc: PA = Elev + (1013 - QNH) * 30
            const pa = Math.round(elev + (1013.25 - qnhHpa) * 30);
            const isaTemp = 15 - (2 * pa / 1000); 
            const isaDev = Math.round(temp - isaTemp);
            // DA Rule of thumb: PA + 120 * (OAT - ISA)
            const da = Math.round(pa + 120 * (temp - isaTemp));
            
            document.getElementById('calcPA').innerText = `${pa} ft`;
            document.getElementById('calcDA').innerText = `${da} ft`;
            document.getElementById('calcISA').innerText = `${isaDev >= 0 ? '+' : ''}${isaDev}¬∞C`;
            
            const fContainer = document.getElementById('freqContainer');
            fContainer.innerHTML = '';
            if(d.frequencies && d.frequencies.length > 0) {
                 d.frequencies.slice(0, 6).forEach(f => {
                     const card = document.createElement('div'); card.className = 'freq-card';
                     card.innerHTML = `<div class="freq-type">${f.type}</div><div class="freq-val">${f.frequency}</div>`;
                     fContainer.appendChild(card);
                 });
            }

            fetch(`https://api.sunrise-sunset.org/json?lat=${d.latitude}&lng=${d.longitude}&formatted=0`)
                .then(r=>r.json()).then(s => {
                    const t = (iso) => new Date(iso).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false});
                    document.getElementById('infoSun').innerText = `üåÖ ${t(s.results.sunrise)}  üåá ${t(s.results.sunset)}`;
                    stationSunTimes = { sunrise: new Date(s.results.sunrise), sunset: new Date(s.results.sunset) };
                    if(tafDataCache) updateTafSkyGradient(new Date(tafDataCache[0].start_time.dt), new Date(tafDataCache[tafDataCache.length-1].end_time.dt));
                }).catch(e=>{});
        }

        // --- WIND ROSE & RUNWAYS ---
        function setupRunwaySelect() {
            const sel = document.getElementById('rwySelect'); sel.innerHTML = '';
            const mv = stationData.magnetic_variation || 0;
            const windMag = currentWind.dir - mv;
            let bestRwy = null, maxHW = -999;
            (stationData.runways || []).forEach(r => {
                sel.add(new Option(`RWY ${r.ident1}`, r.ident1)); sel.add(new Option(`RWY ${r.ident2}`, r.ident2));
                let h1 = parseInt(r.ident1.replace(/\D/g,'')) * 10;
                let hw1 = Math.cos((windMag - h1) * (Math.PI/180)) * currentWind.spd;
                if(hw1 > maxHW) { maxHW = hw1; bestRwy = r.ident1; }
            });
            if(bestRwy) sel.value = bestRwy; else if(stationData.runways.length > 0) sel.value = stationData.runways[0].ident1;
            drawWindRose(); renderRunwaysComplex();
        }

        function drawWindRose() {
            const canvas = document.getElementById('windRose'); const ctx = canvas.getContext('2d'); const w=140, h=140, cx=70, cy=70, r=60;
            const rwyIdent = document.getElementById('rwySelect').value; 
            
            ctx.clearRect(0,0,w,h);
            ctx.beginPath(); ctx.arc(cx, cy, r, 0, 2*Math.PI); ctx.strokeStyle = '#555'; ctx.lineWidth = 2; ctx.stroke();
            ctx.fillStyle = '#8e8e93'; ctx.font = '10px sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText('N', cx, cy - r + 10); ctx.fillText('E', cx + r - 10, cy); ctx.fillText('S', cx, cy + r - 10); ctx.fillText('W', cx - r + 10, cy);
            
            const mv = stationData?.magnetic_variation || 0; 
            const windMag = currentWind.dir - mv;
            
            if(rwyIdent) {
                const rwyHdg = parseInt(rwyIdent.replace(/\D/g,'')) * 10; const rwyRad = (rwyHdg - 90) * (Math.PI/180);
                ctx.save(); ctx.translate(cx, cy); ctx.rotate(rwyRad); 
                ctx.fillStyle = '#333'; ctx.fillRect(-r+15, -6, (r*2)-30, 12); 
                ctx.strokeStyle = '#fff'; ctx.lineWidth = 1; ctx.strokeRect(-r+15, -6, (r*2)-30, 12); 
                ctx.restore();
                
                const diff = (windMag - rwyHdg) * (Math.PI/180); 
                const hw = Math.round(Math.cos(diff) * currentWind.spd); 
                const xw = Math.round(Math.sin(diff) * currentWind.spd);
                
                const vHW = document.getElementById('valHW'); 
                vHW.innerText = hw >= 0 ? `${hw}kt Head` : `${Math.abs(hw)}kt Tail`; 
                vHW.style.color = hw < 0 ? 'var(--danger)' : 'var(--success)';
                document.getElementById('valXW').innerText = `${Math.abs(xw)}kt ${xw >= 0 ? 'L' : 'R'}`;
                
                checkMins();
            }
            if(currentWind.spd > 0) {
                const windRad = (windMag - 90) * (Math.PI/180); 
                ctx.save(); ctx.translate(cx, cy); ctx.rotate(windRad);
                ctx.beginPath(); ctx.moveTo(r-5, 0); ctx.lineTo(10, 0); ctx.strokeStyle = '#0a84ff'; ctx.lineWidth = 3; ctx.stroke();
                ctx.beginPath(); ctx.moveTo(15, -5); ctx.lineTo(5, 0); ctx.lineTo(15, 5); ctx.fillStyle = '#0a84ff'; ctx.fill(); ctx.restore();
            }
        }

        function renderRunwaysComplex() {
            const container = document.getElementById('runwayListComplex'); container.innerHTML = '';
            const d = stationData; if(!d || !d.runways) return;
            const magVar = d.magnetic_variation || 0;
            const windMagDir = currentWind.dir - magVar;
            
            d.runways.forEach((r, idx) => {
                let dimStr = useMetric ? `${Math.round(r.length_ft * 0.3048)}m` : `${r.length_ft}'`;
                const rwy1Hdg = parseInt(r.ident1.replace(/\D/g,'')) * 10;
                const diffRad = (windMagDir - rwy1Hdg) * (Math.PI/180);
                const hw = Math.round(Math.cos(diffRad) * currentWind.spd); 
                const xw = Math.round(Math.sin(diffRad) * currentWind.spd);
                const color1 = hw >= 0 ? 'var(--success)' : 'var(--danger)';
                const color2 = hw < 0 ? 'var(--success)' : 'var(--danger)';
                
                const div = document.createElement('div');
                div.className = 'rwy-complex';
                div.innerHTML = `
                    <div class="rc-header"><div class="rc-idents"><span style="color:${color1}">${r.ident1}</span> / <span style="color:${color2}">${r.ident2}</span></div><div class="rc-dims">${dimStr}</div></div>
                    <div class="rc-strip">
                        <div class="rc-id-v">${r.ident1}</div>
                        <div class="rc-data">
                            <div class="wind-comp"><span>${Math.abs(hw)}kt</span><span style="color:${color1}">${hw>=0?'‚¨Ü':'‚¨á'}</span></div>
                            <div class="wind-comp"><span>${Math.abs(xw)}kt</span><span style="color:#0a84ff">${xw>=0?'‚¨Ö':'‚û°'}</span></div>
                        </div>
                        <div class="rc-id-v" style="transform:rotate(0deg);">${r.ident2}</div>
                    </div>`;
                container.appendChild(div);
            });
        }

        // --- TAF RENDERER ---
        function renderTaf(d) {
            document.getElementById('rawTaf').innerText = d.raw || "No TAF Data";
            tafDataCache = d.forecast; 
            const bar = document.getElementById('tafBar'); const axis = document.getElementById('tafAxis'); 
            bar.innerHTML = ''; axis.innerHTML = '';
            document.getElementById('tafDetail').classList.add('hidden');
            
            if(!d.forecast || d.forecast.length === 0) return;
            
            const startT = new Date(d.forecast[0].start_time.dt);
            const endT = new Date(d.forecast[d.forecast.length-1].end_time.dt);
            const totalDur = endT - startT; const now = new Date();

            if (now >= startT && now <= endT) {
                const p = ((now - startT) / totalDur) * 100;
                const needle = document.getElementById('tafNeedle');
                needle.style.display = 'block'; needle.style.left = `${p}%`;
            }

            d.forecast.forEach((f, index) => {
                const block = document.createElement('div'); block.className = 'taf-block'; block.style.flex = "1";
                let col = '#555'; 
                if(f.flight_rules==='VFR')col='var(--success)'; if(f.flight_rules==='MVFR')col='var(--mvfr)'; if(f.flight_rules==='IFR')col='var(--danger)';
                block.style.backgroundColor = col; block.innerText = f.type;
                block.onclick = () => { showTafDetail(index, col); };
                bar.appendChild(block);
                
                if(index % 2 === 0) {
                    const s = new Date(f.start_time.dt); const lbl = document.createElement('div'); 
                    lbl.className = 'taf-axis-lbl'; lbl.style.flex = "2"; lbl.innerText = `${s.getUTCHours()}z`; axis.appendChild(lbl);
                }
            });
            if (stationSunTimes) updateTafSkyGradient(startT, endT);
        }

        function showTafDetail(index, color) {
            const f = tafDataCache[index]; const card = document.getElementById('tafDetail'); 
            card.style.borderLeftColor = color; card.classList.remove('hidden');
            const s = new Date(f.start_time.dt); const e = new Date(f.end_time.dt);
            document.getElementById('tdTime').innerText = `${s.getUTCHours()}z ‚ûî ${e.getUTCHours()}z`; 
            document.getElementById('tdType').innerText = f.type;
            const wDir = f.wind_direction?.value || 'VRB'; 
            document.getElementById('tdWind').innerText = `${wDir}¬∞ / ${f.wind_speed?.value||0}kt`;
            document.getElementById('tdVis').innerText = f.visibility ? `${f.visibility.value} sm` : 'P6SM';
            document.getElementById('tdWx').innerText = f.wx_codes ? f.wx_codes.map(x => x.repr).join(' ') : 'NSW';
            let cStr = 'SKC'; if(f.clouds && f.clouds.length > 0) cStr = f.clouds.map(c => `${c.type}${c.altitude.toString().padStart(3,'0')}`).join(' '); 
            document.getElementById('tdCloud').innerText = cStr;
        }

        function updateTafSkyGradient(startT, endT) {
            if (!stationSunTimes || !startT || !endT) return;
            const getDecHour = (d) => d.getUTCHours() + (d.getUTCMinutes() / 60);
            const sr = getDecHour(stationSunTimes.sunrise); const ss = getDecHour(stationSunTimes.sunset);
            const cNight = "#0f172a"; const cDay = "#0ea5e9"; const cDawn = "#f97316"; 
            const stops = []; const totalDur = endT - startT; let curr = new Date(startT);
            while (curr <= endT) {
                const h = getDecHour(curr); const pct = ((curr - startT) / totalDur) * 100;
                let isDay = (h >= sr && h < ss);
                const distSR = Math.abs(h - sr); const distSS = Math.abs(h - ss);
                let color = isDay ? cDay : cNight; if (distSR < 0.8 || distSS < 0.8) color = cDawn;
                stops.push(`${color} ${pct.toFixed(1)}%`); curr.setMinutes(curr.getMinutes() + 30);
            }
            document.getElementById('tafSkyStrip').style.background = `linear-gradient(to right, ${stops.join(', ')})`;
        }

        // --- WORLD CLOCK ---
        function initWorldClock() {
            const stored = localStorage.getItem('efb_cities_v46');
            if(stored) cityList = JSON.parse(stored); else cityList = [...AVIATION_CITIES];
        }
        function updateClock() {
            const now = new Date();
            document.getElementById('zuluTime').innerText = `${now.getUTCHours().toString().padStart(2,'0')}:${now.getUTCMinutes().toString().padStart(2,'0')}Z`;
            if(document.getElementById('tab-world').classList.contains('active')) {
                const container = document.getElementById('worldContainer'); container.innerHTML = '';
                cityList.forEach(c => {
                    const timeStr = now.toLocaleTimeString('en-US', { timeZone: c.z, hour: '2-digit', minute: '2-digit', hour12: false });
                    const card = document.createElement('div'); card.className = 'clock-card';
                    card.innerHTML = `<div class="clock-left"><div><span class="clock-city">${c.n}</span><span style="color:var(--accent); font-weight:700; margin-left:8px;">${c.icao||''}</span></div></div><div class="clock-time">${timeStr}</div>`;
                    container.appendChild(card);
                });
            }
        }
        async function addCustomCity() {
            const val = document.getElementById('newCityInput').value; if(!val) return;
            cityList.push({n:val, z:'UTC', icao:'USER'}); localStorage.setItem('efb_cities_v46', JSON.stringify(cityList)); updateClock();
        }

        // --- E6B & MINS ---
        function checkMins() {
            const xwVal = document.getElementById('minXW').value;
            const ceilVal = document.getElementById('minCeil').value;
            const resDiv = document.getElementById('minsResult'); 
            const card = document.getElementById('minsCard');
            const banner = document.getElementById('minBanner');

            // 1. NEUTRAL STATE (If inputs are empty)
            if (xwVal === '' || ceilVal === '') {
                resDiv.innerText = "SET LIMITS"; 
                resDiv.style.backgroundColor = "#333"; 
                resDiv.style.color = "#aaa"; 
                card.style.borderLeftColor = "#555";
                banner.className = 'hidden'; 
                return;
            }

            // 2. ACTIVE CHECK
            const limitXW = parseFloat(xwVal);
            const limitCeil = parseFloat(ceilVal);
            localStorage.setItem('efb_min_xw', limitXW);
            localStorage.setItem('efb_min_ceil', limitCeil);

            if (!currentMetar || !stationData) { 
                resDiv.innerText = "LOAD DATA"; 
                return; 
            }

            const rwyIdent = document.getElementById('rwySelect').value; 
            let actualXW = 0;
            if (rwyIdent) {
                const mv = stationData.magnetic_variation || 0;
                const rwyHdg = parseInt(rwyIdent.replace(/\D/g,'')) * 10;
                const diff = (currentWind.dir - mv - rwyHdg) * (Math.PI/180);
                actualXW = Math.abs(Math.sin(diff) * currentWind.spd);
            }
            let actualCeil = 9999;
            if (lastMetarObj && lastMetarObj.clouds) {
                const ceilLayer = lastMetarObj.clouds.find(c => c.type === 'BKN' || c.type === 'OVC' || c.type === 'VV');
                if (ceilLayer) actualCeil = ceilLayer.altitude * 100;
            }
            
            if (actualXW > limitXW || actualCeil < limitCeil) {
                resDiv.innerText = "NO-GO ‚õî"; 
                resDiv.style.backgroundColor = "var(--danger)"; 
                resDiv.style.color = "#fff"; 
                card.style.borderLeftColor = "var(--danger)";
                banner.className = ''; 
                banner.innerText = `‚ö†Ô∏è NO-GO: ${actualXW > limitXW ? 'X-WIND' : 'CEILING'} EXCEEDED`;
            } else {
                resDiv.innerText = "GO ‚úÖ"; 
                resDiv.style.backgroundColor = "var(--success)"; 
                resDiv.style.color = "#000"; 
                card.style.borderLeftColor = "var(--success)";
                banner.className = 'hidden';
            }
        }

        function calcE6B() {
            const alt = parseFloat(document.getElementById('e6bAlt').value) || 0;
            const qnh = parseFloat(document.getElementById('e6bQnh').value) || 1013;
            const temp = parseFloat(document.getElementById('e6bTemp').value) || 15;
            const ias = parseFloat(document.getElementById('e6bIas').value) || 0;
            const pa = alt + (1013 - qnh) * 30;
            const da = pa + 120 * (temp - (15 - (2*pa/1000)));
            document.getElementById('resDA').innerText = Math.round(da) + " ft";
            const tas = ias * (1 + (alt/1000 * 0.02)); 
            document.getElementById('resTAS').innerText = Math.round(tas) + " kts";
        }

        // --- UTILS ---
        function formatRawMetar(rawText) {
            if (!rawText) return "";
            let html = rawText;
            html = html.replace(/(G\d{2,3}KT)/g, '<span style="color:var(--danger); font-weight:800;">$1</span>');
            html = html.replace(/(\s)(M?(\d\/\d|[0-2]))(SM)/g, '$1<span style="color:var(--lifr); font-weight:800;">$2$4</span>');
            html = html.replace(/(VV\d{3}|OVC00[0-4])/g, '<span style="color:var(--danger); font-weight:800;">$1</span>');
            html = html.replace(/(\s)(\+?\w*TS\w*|\+RA|\+SN|SQ|FC)(\s|$)/g, '$1<span style="color:var(--warn); font-weight:800;">$2</span>$3');
            return html;
        }

        function formatNotamText(raw) {
            if(!raw) return "";
            let h = raw;
            const reCrit = /\b(CLSD|CLOSED|U\/S|UNSERVICEABLE)\b/g;
            h = h.replace(reCrit, '<span class="n-crit">$1</span>');
            const reWarn = /\b(OBST|OBSTACLE|WORK|WIP|DANGER|CAUTION|FUGRO)\b/g;
            h = h.replace(reWarn, '<span class="n-warn">$1</span>');
            const reBold = /\b(RWY|TWY|RUNWAY|TAXIWAY|APRON|TWR)\b/g;
            h = h.replace(reBold, '<span class="n-bold">$1</span>');
            return h;
        }

        function toggleNightMode() {
            const body = document.body;
            body.classList.toggle('cockpit-dark');
            const isDark = body.classList.contains('cockpit-dark');
            const btn = document.getElementById('btnNightMode');
            if(isDark) {
                btn.innerHTML = "<span>‚ö™ Day Mode</span>";
                btn.style.borderColor = "#fff";
                localStorage.setItem('efb_night_mode', 'true');
            } else {
                btn.innerHTML = "<span>üî¥ Cockpit Night Mode</span>";
                btn.style.borderColor = "var(--danger)";
                localStorage.setItem('efb_night_mode', 'false');
            }
            if(document.getElementById('rwySelect').value) drawWindRose();
        }

        function checkNightModeSaved() {
            if(localStorage.getItem('efb_night_mode') === 'true') {
                toggleNightMode();
            }
        }

        function setTab(name) {
            // Standard Tab Switching
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-'+name).classList.add('active');
            
            // Find the button that was clicked and make it active
            // (We iterate to find the one with the matching onclick)
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(t => {
                if(t.getAttribute('onclick').includes(name)) t.classList.add('active');
            });
        
            // --- FIX FOR WORLD CLOCK ---
            if(name === 'world') updateClock();
        
            // --- FIX FOR TAF CHART ---
            // If opening TAF tab and we have data, wait 50ms for the div to become visible, then redraw
            if(name === 'taf' && meteoDataCache) {
                setTimeout(() => {
                    drawMeteogram(meteoDataCache);
                }, 50);
            }
        }
        function updateHeaderCat(status, colorClass) {
            const badge = document.getElementById('headerCat');
            badge.innerText = status; badge.className = 'badge badge-cat ' + colorClass;
        }
        function toggleClearBtn() {
            const val = document.getElementById('icao').value;
            document.getElementById('clearBtn').style.display = val ? 'block' : 'none';
        }
        function clearSearch() { document.getElementById('icao').value = ''; document.getElementById('icao').focus(); toggleClearBtn(); }

        // Start
        initApp();
    </script>
</body>
</html>
