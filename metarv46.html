This is a crucial safety feature. In aviation, "Old Data" is often more dangerous than "No Data" because it gives a false sense of security.
Here is the updated logic. It calculates the age of the report immediately. If the data is older than 60 minutes:
 * It flags the time in Red.
 * It appends the Metar-Taf.com fallback link directly below the raw text so you can quickly check if the station is actually offline or just lagging.
Updated renderMetar Function
Replace your existing renderMetar function with this version.
// --- UPDATED RENDERER WITH STALE DATA CHECK ---
function renderMetar(d) {
    const rawContainer = document.getElementById('rawMetar');
    
    // 1. Calculate Age First
    const now = new Date();
    const metarTime = new Date(d.time.dt);
    const minAgo = Math.floor((now - metarTime) / 60000);

    // 2. Render Smart Text
    rawContainer.innerHTML = formatRawMetar(d.raw);
    
    // 3. Check for Stale Data (> 60 mins)
    if (minAgo > 60) {
        const icao = document.getElementById('icao').value.toUpperCase();
        const staleHtml = `
            <div style="margin-top:12px; padding:10px; background:rgba(255, 69, 58, 0.1); border:1px solid var(--danger); border-radius:6px; text-align:center;">
                <div style="color:var(--danger); font-weight:800; font-size:12px; margin-bottom:8px;">‚ö†Ô∏è DATA OUTDATED (${minAgo}m old)</div>
                <div style="font-size:11px; color:var(--sub-text); margin-bottom:8px;">Station might be offline.</div>
                <a href="https://metar-taf.com/${icao}" target="_blank" class="atc-btn" style="justify-content:center; background:#000; border-color:var(--danger); padding:8px; height:auto; margin-bottom:0;">
                    <span style="font-size:13px;">Check Metar-Taf.com ‚Üó</span>
                </a>
            </div>
        `;
        rawContainer.insertAdjacentHTML('beforeend', staleHtml);
    }

    // 4. Update Header Badge (Flight Rules)
    const rules = d.flight_rules; 
    let css = 'cat-vfr';
    if(rules==='MVFR') css='cat-mvfr'; 
    if(rules==='IFR') css='cat-ifr'; 
    if(rules==='LIFR') css='cat-lifr';
    
    // If stale, we keep the color but maybe add a marker? 
    // For now, we stick to the standard rules but the Big Red Box above handles the warning.
    updateHeaderCat(rules, css);

    // 5. Update Cards
    document.getElementById('mWind').innerText = `${currentWind.dir.toString().padStart(3,'0')}¬∞ / ${currentWind.spd}kt`;
    document.getElementById('mVis').innerText = d.visibility ? `${d.visibility.value} sm` : '--';
    const c = d.clouds?.[0]; 
    document.getElementById('mCeil').innerText = c ? `${c.type} ${c.altitude.toString().padStart(3,'0')}` : "CLR";
    
    const alt = d.altimeter?.value; 
    if(alt) {
        if(currentMetar.altUnit === 'hPa') { 
            const inHg = (alt * 0.02953).toFixed(2); 
            document.getElementById('mAlt').innerText = `Q${alt} / A${inHg}`; 
        } else { 
            const hPa = Math.round(alt * 33.8639); 
            document.getElementById('mAlt').innerText = `Q${hPa} / A${alt.toFixed(2)}`; 
        }
    }

    const t = d.temperature?.value, dew = d.dewpoint?.value;
    if(t!=null) {
        document.getElementById('mTempC').innerText = `${t}¬∞C / ${dew!=null?dew:'--'}¬∞C`;
        document.getElementById('mTempF').innerText = `(${Math.round(t*1.8+32)}¬∞F)`;
        document.getElementById('mSpread').innerText = `Spread: ${(t-dew).toFixed(1)}¬∞C`;
    }

    // 6. Update Age Footer
    const ageEl = document.getElementById('mAge');
    ageEl.innerText = `${minAgo}m ago`;
    // Turn the age text RED if old
    if (minAgo > 60) {
        ageEl.style.color = 'var(--danger)';
        ageEl.style.fontWeight = '700';
    } else {
        ageEl.style.color = 'var(--sub-text)';
        ageEl.style.fontWeight = '400';
    }
}

Full File (Optional)
If you prefer to copy the whole thing to be safe, here is the complete file again with the new renderMetar function integrated.
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>METAR PLUS</title>
    <meta name="apple-mobile-web-app-title" content="METAR PLUS">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/vincent6786/Notion_metar_advanced/main/app-icon.png">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/vincent6786/Notion_metar_advanced/main/app-icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        /* --- 1. CORE THEME & LAYOUT --- */
        :root {
            --bg: #000000; --card-bg: #1c1c1e; --text: #ffffff; --sub-text: #8e8e93;
            --border: #38383a; --accent: #0a84ff; 
            --danger: #ff453a; --warn: #ff9f0a; --success: #32d74b;
            --mvfr: #0a84ff; --lifr: #bf5af2;
            --sky-bg: #131d2e;
        }
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, sans-serif;
            background-color: var(--bg); color: var(--text);
            margin: 0; padding: 12px; font-size: 14px; line-height: 1.4;
            display: flex; flex-direction: column; gap: 12px;
            padding-bottom: 50px; overscroll-behavior-y: none;
        }

        /* --- 2. ANIMATIONS --- */
        @keyframes slideUpFade {
            0% { opacity: 0; transform: translateY(20px) scale(0.98); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        .view-section.active > * { animation: slideUpFade 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) both; }

        /* --- 3. HEADER & SEARCH --- */
        .top-bar { display: flex; align-items: center; gap: 8px; height: 40px; }
        .search-wrapper { flex-grow: 1; position: relative; display: flex; align-items: center; }
        .search-box {
            width: 100%; background: var(--card-bg); border-radius: 8px; 
            display: flex; align-items: center; border: 1px solid var(--border);
            padding-left: 8px; transition: border-color 0.2s;
        }
        .search-box:focus-within { border-color: var(--accent); }
        #icao {
            flex-grow: 1; background: transparent; border: none; color: #fff; 
            padding: 8px 4px; text-transform: uppercase; font-weight: 700; 
            font-size: 16px; outline: none; width: 100%;
        }
        .clear-btn { color: var(--sub-text); cursor: pointer; padding: 0 8px; font-size: 14px; display: none; }
        .icon-btn { 
            background: var(--card-bg); border: 1px solid var(--border); color: var(--accent); 
            width: 40px; height: 100%; border-radius: 8px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; text-decoration: none; font-size: 18px;
        }
        .icon-btn:hover { background: #2c2c2e; }
        .badge { height: 100%; display: flex; align-items: center; justify-content: center; padding: 0 12px; border-radius: 8px; font-weight: 700; font-size: 15px; min-width: 60px; }
        .badge-time { background: var(--card-bg); border: 1px solid var(--border); color: #fff; font-family: 'SF Mono', monospace; letter-spacing: -0.5px; }
        .badge-cat { background: var(--card-bg); color: var(--sub-text); transition: background 0.3s, color 0.3s; }
        .cat-vfr { background-color: var(--success) !important; color: #000 !important; }
        .cat-mvfr { background-color: var(--mvfr) !important; color: #fff !important; }
        .cat-ifr { background-color: var(--danger) !important; color: #fff !important; }
        .cat-lifr { background-color: var(--lifr) !important; color: #fff !important; }

        /* --- 4. TABS --- */
        .tabs { display: flex; border-bottom: 1px solid var(--border); gap: 20px; padding: 0 4px; overflow-x: auto; scrollbar-width: none; }
        .tab { padding: 10px 0; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--sub-text); border-bottom: 2px solid transparent; text-transform: uppercase; white-space: nowrap; }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

        /* --- 5. UTILS --- */
        .view-section { display: none; }
        .view-section.active { display: block; }
        .hidden { display: none !important; }
        .section-title { font-weight:700; color:var(--sub-text); margin: 20px 0 8px 0; font-size:12px; text-transform: uppercase; letter-spacing: 0.5px; }
        .raw-text { 
            font-family: 'SF Mono', monospace; font-size: 13px; color: #d0d0d0; 
            margin-top: 6px; line-height: 1.4; white-space: pre-wrap; word-break: break-word; 
            background: rgba(255,255,255,0.05); padding: 8px; border-radius: 6px; 
        }

        /* --- 6. METAR & SKY VIZ --- */
        .metar-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .metar-card { background: var(--card-bg); border-radius: 8px; padding: 10px; display: flex; flex-direction: column; justify-content: center; }
        .metar-card.full-width { grid-column: span 2; }
        .m-label { font-size: 11px; color: var(--sub-text); font-weight: 600; text-transform: uppercase; margin-bottom: 4px; }
        .m-value { font-size: 16px; font-weight: 600; color: #fff; }
        .m-sub { font-size: 12px; color: var(--sub-text); font-weight: 400; margin-left: 4px;}
        .metar-footer { display: flex; justify-content: space-between; margin-top: 8px; padding: 0 4px; font-size: 12px; color: var(--sub-text); }
        
        /* NEW SKY LAYOUT */
        .sky-section {
            grid-column: span 2;
            background: var(--sky-bg);
            border-radius: 12px;
            padding: 16px;
            position: relative;
            overflow: hidden;
        }
        .sky-header { font-size: 11px; color: rgba(255,255,255,0.4); font-weight: 700; margin-bottom: 12px; text-transform: uppercase; }
        
        .sky-layer { display: flex; flex-direction: column; margin-bottom: 14px; }
        .sky-icons-row { display: flex; gap: 12px; margin-bottom: 4px; align-items: flex-end; }
        .sky-icon { width: 32px; height: 20px; fill: #d1d5db; opacity: 0.9; }
        .sky-layer-text { font-size: 15px; font-weight: 500; color: #fff; }
        .sky-no-data { text-align: center; color: rgba(255,255,255,0.3); padding: 20px; font-style: italic; }

        /* NEW FLIGHT RULE BAR */
        .fr-bar-container { grid-column: span 2; background: var(--card-bg); padding: 12px; border-radius: 8px; margin-top: 4px; }
        .fr-header-row { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 6px; }
        .fr-title { font-size: 11px; color: var(--sub-text); font-weight: 700; text-transform: uppercase; }
        .fr-track { display: flex; height: 6px; width: 100%; background: #333; border-radius: 3px; overflow: hidden; margin-bottom: 6px; }
        .fr-seg { flex: 1; margin-right: 2px; background: #444; opacity: 0.3; transition: opacity 0.3s; }
        .fr-seg:last-child { margin-right: 0; }
        
        .fr-seg.active.lifr { background: var(--lifr); opacity: 1; box-shadow: 0 0 8px var(--lifr); }
        .fr-seg.active.ifr { background: var(--danger); opacity: 1; box-shadow: 0 0 8px var(--danger); }
        .fr-seg.active.mvfr { background: var(--mvfr); opacity: 1; box-shadow: 0 0 8px var(--mvfr); }
        .fr-seg.active.vfr { background: var(--success); opacity: 1; box-shadow: 0 0 8px var(--success); }

        .fr-labels { display: flex; font-size: 10px; color: #666; font-weight: 700; width: 100%; text-transform: uppercase; }
        .fr-lbl-item { flex: 1; text-align: left; padding-left: 2px; }
        .fr-msg { margin-top: 8px; font-size: 14px; color: #fff; font-weight: 500; }

        .wind-vis-container { background: var(--card-bg); border-radius: 8px; padding: 12px; margin-top: 12px; display: flex; gap: 15px; align-items: center; }
        .wind-controls { flex-grow: 1; display: flex; flex-direction: column; gap: 8px; }
        .wind-stats { font-family: 'SF Mono', monospace; font-size: 13px; color: #fff; margin-top: 5px; }
        .stat-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #333; }
        select.stealth-select { background: #2c2c2e; border: 1px solid var(--border); color: #fff; padding: 6px; border-radius: 6px; width: 100%; font-weight: 600; outline: none; }

        /* --- 7. TAF & INFO --- */
        .taf-viz-container { margin-top: 10px; position: relative; }
        .taf-bar { display: flex; height: 32px; width: 100%; background: #2c2c2e; border-radius: 6px; overflow: hidden; border: 1px solid var(--border); position: relative; z-index: 2; }
        .taf-sky-strip { height: 6px; width: 100%; margin-top: 2px; border-radius: 3px; background: #333; overflow: hidden; position: relative; }
        .taf-axis { display: flex; width: 100%; margin-top: 4px; margin-bottom: 12px; }
        .taf-block { cursor: pointer; position: relative; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 800; color: rgba(0,0,0,0.6); border-right: 1px solid rgba(0,0,0,0.1); transition: opacity 0.2s; text-transform: uppercase; }
        .taf-block:hover { opacity: 0.8; }
        .taf-block.selected { border: 2px solid #fff; z-index: 10; box-shadow: 0 0 10px rgba(0,0,0,0.5); color: #000; }
        .taf-axis-lbl { text-align: center; font-size: 10px; color: var(--sub-text); font-family: 'SF Mono', monospace; border-right: 1px solid transparent; }
        .taf-detail-card { background: var(--card-bg); border-radius: 8px; padding: 16px; border-left: 4px solid var(--sub-text); animation: slideUpFade 0.2s ease-out; }
        #tafNeedle { position: absolute; top: -4px; bottom: -8px; width: 2px; background: #ff453a; z-index: 20; pointer-events: none; box-shadow: 0 0 8px #ff453a; transition: left 0.5s ease-out; display: none; }
        #tafNeedle::after { content: ''; position: absolute; top: -4px; left: -4px; width: 10px; height: 10px; background: #ff453a; border-radius: 50%; border: 2px solid #000; }

        /* --- 8. INFO & RUNWAYS --- */
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
        .info-card { background: var(--card-bg); padding: 10px; border-radius: 8px; }
        .ic-lbl { font-size: 11px; color: var(--sub-text); text-transform: uppercase; }
        .ic-val { font-size: 15px; font-weight: 600; color: #fff; margin-top: 2px; }
        .freq-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 8px; }
        .freq-card { background: var(--card-bg); border-radius: 8px; padding: 10px; text-align: center; }
        .freq-type { font-size: 11px; color: var(--sub-text); text-transform: uppercase; margin-bottom: 4px; }
        .freq-val { font-size: 16px; font-weight: 700; color: var(--accent); font-family: 'SF Mono', monospace; }
        
        .rwy-complex { margin-bottom: 16px; }
        .rc-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 4px; padding: 0 4px; }
        .rc-idents { font-size: 16px; font-weight: 800; font-family: 'SF Mono', monospace; }
        .rc-strip { height: 44px; background: var(--strip-bg); border-radius: 8px; display: flex; align-items: center; justify-content: space-between; padding: 0 6px; overflow: hidden; position: relative; }
        .rc-id-v { font-size: 12px; font-weight: 700; color: #fff; writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); padding: 0 4px; }
        .rc-data { flex-grow: 1; display: flex; align-items: center; justify-content: center; gap: 12px; }
        .wind-comp { display: flex; align-items: center; gap: 2px; font-size: 14px; font-weight: 600; color: #fff; }
        
        /* --- 9. BUTTONS & TOOLS --- */
        .atc-btn { display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); padding: 14px 16px; border-radius: 10px; text-decoration: none; color: #fff; font-weight: 600; font-size: 15px; border: 1px solid var(--border); transition: background 0.2s; margin-bottom: 10px; }
        .atc-btn:hover { background: #2c2c2e; border-color: var(--accent); }
        .tool-btn { background: #333; border: 1px solid var(--border); color: #fff; width: 100%; padding: 8px; border-radius: 6px; cursor: pointer; margin-top: 4px; font-weight: 600; }
        .nearby-container { grid-column: span 2; display: flex; flex-direction: column; gap: 4px; margin-top: 8px; }
        .nearby-header { font-size: 11px; color: var(--sub-text); font-weight: 700; }
        .nearby-list { display: flex; gap: 6px; flex-wrap: wrap; }
        .nearby-btn {
            background: #2c2c2e; border: 1px solid var(--border); color: #fff;
            padding: 6px 10px; border-radius: 6px; font-size: 12px; font-weight: 600;
            cursor: pointer; display: flex; align-items: center; gap: 4px;
        }
        .nearby-btn:hover { background: #3a3a3c; }

        /* --- 10. CLOCK --- */
        .clock-card { background: var(--card-bg); border-radius: 8px; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #2c2c2e; margin-bottom: 8px; }
        .clock-time { font-family: 'SF Mono', monospace; font-size: 28px; font-weight: 400; color: #fff; letter-spacing: 0.5px; }
        .clock-utc { color: var(--success); font-weight: 600;}
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="search-wrapper">
            <div class="search-box">
                <span style="padding-left:4px">üîç</span>
                <input type="text" id="icao" placeholder="Search (e.g. KJFK)" onkeydown="if(event.key==='Enter') loadData()" oninput="toggleClearBtn()">
                <span id="clearBtn" class="clear-btn" onclick="clearSearch()">‚úñ</span>
            </div>
        </div>
        <button class="icon-btn" onclick="loadData()" title="Force Refresh">‚Üª</button>
        
        <div id="headerCat" class="badge badge-cat">--</div>
        <div id="zuluTime" class="badge badge-time">--:--Z</div>
        <a id="linkSkyVector" href="#" target="_blank" class="icon-btn" title="Charts">üó∫Ô∏è</a>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="setTab('metar')">METAR</div>
        <div class="tab" onclick="setTab('taf')">TAF</div>
        <div class="tab" onclick="setTab('info')">INFO</div>
        <div class="tab" onclick="setTab('atc')">ATC</div>
        <div class="tab" onclick="setTab('world')">WORLD</div>
        <div class="tab" onclick="setTab('tools')">TOOLS</div>
    </div>

    <div id="tab-metar" class="view-section active">
        
        <div class="wind-vis-container">
            <canvas id="windRose" width="140" height="140" style="width:140px; height:140px;"></canvas>
            <div class="wind-controls">
                <div class="m-label">Selected Runway</div>
                <select id="rwySelect" class="stealth-select" onchange="drawWindRose()">
                    <option value="">Loading...</option>
                </select>
                <div class="wind-stats">
                    <div class="stat-row"><span class="info-label">Headwind</span> <span id="valHW">--</span></div>
                    <div class="stat-row"><span class="info-label">Crosswind</span> <span id="valXW">--</span></div>
                </div>
            </div>
        </div>

        <div class="metar-grid">
            
            <div id="skyVisuals" class="sky-section">
                <div class="sky-header">Sky Cover (AGL)</div>
                <div id="skyLayersContainer">
                    <div class="sky-no-data">Scanning Sky...</div>
                </div>
            </div>

            <div class="fr-bar-container">
                <div class="fr-header-row">
                    <div class="fr-title">Visibility / Ceiling</div>
                    <div class="fr-title" style="color:#fff;">Ceiling + Visibility</div>
                </div>
                <div class="fr-track">
                    <div id="frSegLIFR" class="fr-seg"></div>
                    <div id="frSegIFR" class="fr-seg"></div>
                    <div id="frSegMVFR" class="fr-seg"></div>
                    <div id="frSegVFR" class="fr-seg"></div>
                </div>
                <div class="fr-labels">
                    <div class="fr-lbl-item">LIFR</div>
                    <div class="fr-lbl-item">IFR</div>
                    <div class="fr-lbl-item">MVFR</div>
                    <div class="fr-lbl-item">VFR</div>
                </div>
                <div id="frMessage" class="fr-msg">--</div>
            </div>
            
            <div class="metar-card"><div class="m-label">WIND</div><div class="m-value" id="mWind">--</div></div>
            <div class="metar-card"><div class="m-label">VISIBILITY</div><div class="m-value" id="mVis">--</div></div>
            <div class="metar-card"><div class="m-label">CEILING</div><div class="m-value" id="mCeil">--</div></div>
            <div class="metar-card"><div class="m-label">ALTIMETER</div><div class="m-value" id="mAlt">--</div></div>
            <div class="metar-card full-width"><div class="m-label">TEMP / DEWPOINT</div><div class="m-value"><span id="mTempC">--</span> <span id="mTempF" class="m-sub">--</span></div></div>
        </div>

        <div class="raw-text" id="rawMetar">Enter an airport code above.</div>
        <div class="metar-footer"><span id="mAge">--</span><span id="mSpread">Spread: --</span></div>
        
        <div id="nearbyContainer" class="nearby-container">
            <div class="nearby-header">NEARBY STATIONS</div>
            <div id="nearList" class="nearby-list">
                <span style="color:#555; font-size:12px;">Loading nearby...</span>
            </div>
        </div>
    </div>

    <div id="tab-taf" class="view-section">
        <div style="display:flex; justify-content:space-between; color:var(--sub-text); font-size:12px; margin-bottom:8px;">
            <span>Forecast Visualization</span><span id="tafIssued">--</span>
        </div>
        <div class="taf-viz-container">
            <div id="tafNeedle"></div>
            <div id="tafBar" class="taf-bar"></div>
            <div id="tafSkyStrip" class="taf-sky-strip"></div>
            <div id="tafAxis" class="taf-axis"></div>
            <div id="tafDetail" class="taf-detail-card hidden">
                <div class="td-header" style="display:flex; justify-content:space-between; margin-bottom:12px;"><span id="tdTime" style="font-weight:700;">--</span><span id="tdType" style="background:#444; padding:2px 6px; border-radius:4px;">--</span></div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <div><span class="m-label">WIND</span><div id="tdWind" style="font-weight:600;">--</div></div>
                    <div><span class="m-label">VISIBILITY</span><div id="tdVis" style="font-weight:600;">--</div></div>
                    <div><span class="m-label">WEATHER</span><div id="tdWx" style="font-weight:600;">--</div></div>
                    <div><span class="m-label">CLOUDS</span><div id="tdCloud" style="font-weight:600;">--</div></div>
                </div>
            </div>
        </div>
        <div style="margin-top:20px; font-weight:700; color:var(--sub-text);">Raw TAF</div>
        <div class="raw-text" id="rawTaf">Loading...</div>
        <div style="margin-top:20px; font-weight:700; color:var(--sub-text);">NOTAMs</div>
        <div id="notamList" class="raw-text" style="max-height:200px; overflow-y:auto; font-size:11px;">Loading...</div>
    </div>
    
    <div id="tab-info" class="view-section">
        <div style="font-size:20px; font-weight:700; margin-bottom:4px;" id="infoName">Unknown</div>
        <div style="font-size:12px; color:var(--sub-text); margin-bottom:12px;" id="infoLoc">--</div>
        <div class="info-grid">
            <div class="info-card"><div class="ic-lbl">ICAO / IATA</div><div class="ic-val" id="infoCodes">--</div></div>
            <div class="info-card"><div class="ic-lbl">Elevation</div><div class="ic-val" id="infoElev">--</div></div>
            <div class="info-card" style="grid-column: span 2;"><div class="ic-lbl">Coordinates</div><div class="ic-val" style="font-size:13px;" id="infoCoords">--</div></div>
        </div>
        <div class="section-title">ATMOSPHERE & TIME</div>
        <div class="info-grid">
            <div class="info-card"><div class="ic-lbl">Pressure Alt</div><div class="ic-val" id="calcPA">--</div></div>
            <div class="info-card"><div class="ic-lbl">Density Alt</div><div class="ic-val" id="calcDA">--</div></div>
            <div class="info-card"><div class="ic-lbl">ISA Dev</div><div class="ic-val" id="calcISA">--</div></div>
            <div class="info-card"><div class="ic-lbl">Sunrise/Set</div><div class="ic-val" style="font-size:13px;" id="infoSun">--</div></div>
        </div>
        <div class="section-title">RUNWAYS & FREQ</div>
        <div id="freqContainer" class="freq-grid"></div>
        <div class="section-title">RUNWAY WIND COMPONENTS</div>
        <div id="runwayListComplex"></div>
    </div>
    
    <div id="tab-atc" class="view-section">
        <div class="info-card" style="margin-bottom: 20px;" id="audioContainer">
             <div class="ic-lbl" style="margin-bottom:8px;" id="audioLabel">AUDIO / ATIS</div>
             <div id="audioPlayerTarget"></div>
        </div>
        <div class="section-title">EXTERNAL RESOURCES</div>
        <a href="https://metar-taf.com/" target="_blank" class="atc-btn"><span>‚òÅÔ∏è Metar-Taf.com</span><span>‚Üó</span></a>
        <a href="https://beta.twatc.net/" target="_blank" class="atc-btn"><span>üáπüáº Taiwan Virtual ATC</span><span>‚Üó</span></a>
        <a href="https://www.liveatc.net/" target="_blank" class="atc-btn"><span>üì° LiveATC.net</span><span>‚Üó</span></a>
    </div>

    <div id="tab-world" class="view-section">
        <div style="display:flex; gap:8px; margin-bottom:12px; background:#2c2c2e; padding:8px; border-radius:8px;">
            <input type="text" id="newCityInput" class="conv-inp" placeholder="City Name (e.g. Paris)..." style="margin:0;">
            <button class="tool-btn" style="width:auto; margin:0;" onclick="addCustomCity()">Add</button>
        </div>
        <div id="worldContainer"></div>
    </div>

    <div id="tab-tools" class="view-section">
        <div class="section-title" style="margin-top:0;">Personal Minimums</div>
        <div class="info-card" style="border-left: 4px solid #555;" id="minsCard">
            <div class="conv-row">
                <div style="flex:1"><div class="conv-lbl">Max X-Wind (kt)</div><input type="number" id="minXW" class="conv-inp" value="10" oninput="checkMins()"></div>
                <div style="flex:1"><div class="conv-lbl">Min Ceiling (ft)</div><input type="number" id="minCeil" class="conv-inp" value="2000" oninput="checkMins()"></div>
            </div>
            <div id="minsResult" style="margin-top:10px; font-weight:800; font-size:18px; text-align:center; padding:10px; border-radius:6px; background:#333; color:#aaa;">LOAD DATA</div>
        </div>

        <div class="section-title">E6B Flight Computer</div>
        <div class="info-card">
            <div class="conv-row">
                <div style="flex:1"><div class="conv-lbl">Alt (ft)</div><input type="number" id="e6bAlt" class="conv-inp" oninput="calcE6B()"></div>
                <div style="flex:1"><div class="conv-lbl">QNH</div><input type="number" id="e6bQnh" class="conv-inp" value="1013" oninput="calcE6B()"></div>
                <div style="flex:1"><div class="conv-lbl">Temp (¬∞C)</div><input type="number" id="e6bTemp" class="conv-inp" oninput="calcE6B()"></div>
            </div>
            <div class="conv-row">
                <div style="flex:1"><div class="conv-lbl">IAS (kts)</div><input type="number" id="e6bIas" class="conv-inp" oninput="calcE6B()"></div>
            </div>
            <div class="info-grid" style="margin-top:10px;">
                <div><div class="ic-lbl">Density Alt</div><div class="ic-val" id="resDA" style="color:var(--accent);">--</div></div>
                <div><div class="ic-lbl">TAS</div><div class="ic-val" id="resTAS" style="color:var(--success);">--</div></div>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBALS ---
        const AVWX_KEY = '7BVPOe0lM6CvvLCOGwmcmCxTp1n6PgCdcBJ9Lnt3WpI';
        let currentWind = { dir:0, spd:0 }; 
        let currentMetar = { temp: 15, alt: 1013, altUnit: 'hPa' };
        let stationData = null;
        let stationSunTimes = null;
        let useMetric = true; 
        let tafDataCache = null;
        let lastMetarObj = null; 

        // Embedded Database
        const AVIATION_CITIES = [
            {n:"Taipei",z:"Asia/Taipei",icao:"RCTP",iata:"TPE"}, {n:"Tokyo Narita",z:"Asia/Tokyo",icao:"RJAA",iata:"NRT"}, 
            {n:"New York JFK",z:"America/New_York",icao:"KJFK",iata:"JFK"}, {n:"London LHR",z:"Europe/London",icao:"EGLL",iata:"LHR"}, 
            {n:"Los Angeles",z:"America/Los_Angeles",icao:"KLAX",iata:"LAX"}
        ];
        let cityList = [];
        
        // Cloud Icon SVG Path
        const CLOUD_ICON_PATH = "M25 15C25 10.58 21.42 7 17 7C16.5 7 16 7.05 15.54 7.15C14.73 4.19 12.06 2 9 2C5.13 2 2 5.13 2 9C2 9.17 2 9.35 2.03 9.5C0.84 10.19 0 11.5 0 13C0 15.21 1.79 17 4 17H25C27.76 17 30 14.76 30 12C30 9.24 27.76 7 25 7V15Z";

        // --- INIT ---
        function initApp() {
            initWorldClock();
            loadData();
            setInterval(updateClock, 1000);
        }

        // --- CORE DATA LOADING ---
        async function loadData() {
            const inputEl = document.getElementById('icao');
            if(!inputEl.value) inputEl.value = localStorage.getItem('efb_last_station') || 'RCTP';
            
            const icao = inputEl.value.toUpperCase();
            if(!icao) return;
            
            localStorage.setItem('efb_last_station', icao);
            inputEl.blur();
            document.getElementById('linkSkyVector').href = `https://skyvector.com/airport/${icao}`;
            updateHeaderCat('Loading', '');
            
            const rawContainer = document.getElementById('rawMetar');
            rawContainer.innerHTML = 'Loading...';
            document.getElementById('nearList').innerHTML = '<span style="color:#555;">Scanning...</span>';

            const headers = { 'Authorization': `Bearer ${AVWX_KEY}` };
            const cb = Date.now();
            
            try {
                // 1. Station Info
                const stationResp = await fetch(`https://avwx.rest/api/station/${icao}?t=${cb}`, {headers});
                if(!stationResp.ok) throw new Error("Station Not Found");
                stationData = await stationResp.json();
                renderInfo(stationData); 

                // 2. Fetch WX
                const [metarRes, tafRes, notamRes] = await Promise.allSettled([
                    fetch(`https://avwx.rest/api/metar/${icao}?t=${cb}`, {headers}).then(r=>r.json()),
                    fetch(`https://avwx.rest/api/taf/${icao}?t=${cb}`, {headers}).then(r=>r.json()),
                    fetch(`https://avwx.rest/api/notam/${icao}?t=${cb}`, {headers}).then(r=>r.json())
                ]);

                if(metarRes.status === 'fulfilled' && !metarRes.value.error) {
                    const m = metarRes.value;
                    lastMetarObj = m;
                    currentWind = { dir: m.wind_direction?.value||0, spd: m.wind_speed?.value||0 };
                    
                    let altVal = m.altimeter?.value || 1013;
                    let altUnit = altVal < 200 ? 'inHg' : 'hPa';
                    currentMetar = { temp: m.temperature?.value || 15, alt: altVal, altUnit: altUnit };
                    
                    renderMetar(m); 
                    
                    // CALL NEW RENDERERS
                    renderSkyVisuals(m);
                    renderFlightRuleBar(m);

                    setupRunwaySelect();
                    findNearbyStations(stationData.latitude, stationData.longitude); 
                } else {
                    throw new Error("No Weather Data");
                }

                if(tafRes.status === 'fulfilled') renderTaf(tafRes.value);
                if(notamRes.status === 'fulfilled') {
                    const n = notamRes.value;
                    document.getElementById('notamList').innerHTML = Array.isArray(n) ? 
                        n.map(x => `<div style="margin-bottom:8px; border-left:3px solid var(--warn); padding-left:6px;">${x.raw}</div>`).join('') : "No Data";
                }

                // Audio Setup
                const audioTarget = document.getElementById('audioPlayerTarget');
                if(icao.startsWith('RC')) {
                    document.getElementById('audioLabel').innerText = `${icao} ATIS (TWATC)`;
                    audioTarget.innerHTML = `<audio controls style="width: 100%; height: 32px; filter: invert(0.9);"><source src="https://stream.twatc.net/${icao}_ATIS" type="audio/mpeg"></audio>`;
                } else {
                    document.getElementById('audioLabel').innerText = "External Audio";
                    audioTarget.innerHTML = `<a href="https://www.liveatc.net/search/?q=${icao}" target="_blank" class="tool-btn" style="text-align:center; display:block; text-decoration:none;">üì° Search LiveATC</a>`;
                }

            } catch(e) {
                console.error(e);
                updateHeaderCat('N/A', 'cat-ifr');
                // --- NEW ERROR HANDLING: FALLBACK TO METAR-TAF.COM ---
                const icao = document.getElementById('icao').value.toUpperCase();
                rawContainer.innerHTML = `
                    <div style="text-align:center; padding:20px 10px;">
                        <div style="color:var(--danger); font-weight:800; margin-bottom:15px;">STATION DATA UNAVAILABLE</div>
                        <div style="color:var(--sub-text); font-size:12px; margin-bottom:15px;">The API could not fetch data for <b>${icao}</b>. It might be offline or incorrect.</div>
                        <a href="https://metar-taf.com/${icao}" target="_blank" class="atc-btn" style="justify-content:center; background:var(--accent); border:none; color:#fff;">
                            <span>View on Metar-Taf.com ‚Üó</span>
                        </a>
                        <a href="https://skyvector.com/airport/${icao}" target="_blank" class="tool-btn" style="display:block; text-align:center; text-decoration:none; margin-top:8px;">
                            Check SkyVector
                        </a>
                    </div>
                `;
                document.getElementById('nearList').innerHTML = '<span style="color:var(--danger)">Search failed</span>';
            }
        }

        // --- NEW: SKY VISUALIZER (ICONS) ---
        function renderSkyVisuals(m) {
            const container = document.getElementById('skyLayersContainer');
            container.innerHTML = '';

            // Handle clear skies
            if (!m.clouds || m.clouds.length === 0) {
                container.innerHTML = '<div class="sky-no-data">Sky Clear (SKC/CLR)</div>';
                return;
            }

            // Sort clouds descending (Highest first) to mimic visual stacking
            // Copy array to avoid mutating original
            const sortedClouds = [...m.clouds].sort((a,b) => b.altitude - a.altitude);

            sortedClouds.forEach(c => {
                const layer = document.createElement('div');
                layer.className = 'sky-layer';
                
                // Determine icon count
                let count = 0;
                if(c.type === 'FEW') count = 2;
                else if(c.type === 'SCT') count = 4;
                else if(c.type === 'BKN') count = 7;
                else if(c.type === 'OVC' || c.type === 'VV') count = 8;

                // Icons Row
                let iconsHtml = '';
                for(let i=0; i<count; i++) {
                    iconsHtml += `<svg class="sky-icon" viewBox="0 0 30 20"><path d="${CLOUD_ICON_PATH}"/></svg>`;
                }

                const typeName = {
                    'FEW': 'Few', 'SCT': 'Scattered', 'BKN': 'Broken', 'OVC': 'Overcast', 'VV': 'Vert. Vis'
                }[c.type] || c.type;

                const altFt = c.altitude * 100;

                layer.innerHTML = `
                    <div class="sky-icons-row">${iconsHtml}</div>
                    <div class="sky-layer-text">${typeName} ${altFt}'</div>
                `;
                container.appendChild(layer);
            });
        }

        // --- NEW: FLIGHT RULE BAR ---
        function renderFlightRuleBar(m) {
            // Reset
            ['LIFR', 'IFR', 'MVFR', 'VFR'].forEach(r => document.getElementById(`frSeg${r}`).classList.remove('active', 'lifr', 'ifr', 'mvfr', 'vfr'));
            
            const rule = m.flight_rules; // e.g., "VFR"
            const vis = m.visibility ? m.visibility.value : 99;
            const ceilObj = m.clouds ? m.clouds.find(c => c.type === 'BKN' || c.type === 'OVC') : null;
            const ceil = ceilObj ? ceilObj.altitude * 100 : 99999;

            // Highlight Logic
            const seg = document.getElementById(`frSeg${rule}`);
            if(seg) seg.classList.add('active', rule.toLowerCase());

            // Explanation Text
            const msgEl = document.getElementById('frMessage');
            if (rule === 'VFR') {
                msgEl.innerText = `Visibility > 5 SM and Ceiling > 3000'`;
                msgEl.style.color = 'var(--success)';
            } else if (rule === 'MVFR') {
                msgEl.innerText = `Ceiling 1000-3000' or Vis 3-5 SM`;
                msgEl.style.color = 'var(--mvfr)';
            } else if (rule === 'IFR') {
                msgEl.innerText = `Ceiling < 1000' or Vis < 3 SM`;
                msgEl.style.color = 'var(--danger)';
            } else if (rule === 'LIFR') {
                msgEl.innerText = `Ceiling < 500' or Vis < 1 SM`;
                msgEl.style.color = 'var(--lifr)';
            }
        }

        // --- RESTORED: NEARBY ---
        async function findNearbyStations(lat, lon) {
            try {
                const headers = { 'Authorization': `Bearer ${AVWX_KEY}` };
                const url = `https://avwx.rest/api/station/near/${lat},${lon}?n=5`; 
                const res = await fetch(url, { headers });
                const data = await res.json();
                
                const list = document.getElementById('nearList');
                list.innerHTML = "";
                const currentIcao = document.getElementById('icao').value.toUpperCase();
                
                // Filter out current station
                const others = data.filter(item => item.station.icao !== currentIcao).slice(0, 4);

                if(others.length === 0) {
                    list.innerHTML = "<span style='color:#555;'>No stations found nearby.</span>";
                    return;
                }

                others.forEach(item => {
                    const stn = item.station;
                    const btn = document.createElement('div');
                    btn.className = "nearby-btn";
                    btn.innerHTML = `<span>‚úà</span><span>${stn.icao}</span><span style="color:var(--sub-text); font-size:10px;">${Math.round(item.nautical_miles)}nm</span>`;
                    btn.onclick = () => {
                        document.getElementById('icao').value = stn.icao;
                        loadData(); 
                    };
                    list.appendChild(btn);
                });
            } catch(e) {
                console.error("Nearby search failed", e);
                document.getElementById('nearList').innerHTML = "<span style='color:var(--danger)'>Nearby search failed</span>";
            }
        }

        // --- RENDERERS ---
        
        // --- UPDATED RENDERER WITH STALE DATA CHECK ---
        function renderMetar(d) {
            const rawContainer = document.getElementById('rawMetar');
            
            // 1. Calculate Age First
            const now = new Date();
            const metarTime = new Date(d.time.dt);
            const minAgo = Math.floor((now - metarTime) / 60000);

            // 2. Render Smart Text
            rawContainer.innerHTML = formatRawMetar(d.raw);
            
            // 3. Check for Stale Data (> 60 mins)
            if (minAgo > 60) {
                const icao = document.getElementById('icao').value.toUpperCase();
                const staleHtml = `
                    <div style="margin-top:12px; padding:10px; background:rgba(255, 69, 58, 0.1); border:1px solid var(--danger); border-radius:6px; text-align:center;">
                        <div style="color:var(--danger); font-weight:800; font-size:12px; margin-bottom:8px;">‚ö†Ô∏è DATA OUTDATED (${minAgo}m old)</div>
                        <div style="font-size:11px; color:var(--sub-text); margin-bottom:8px;">Station might be offline.</div>
                        <a href="https://metar-taf.com/${icao}" target="_blank" class="atc-btn" style="justify-content:center; background:#000; border-color:var(--danger); padding:8px; height:auto; margin-bottom:0;">
                            <span style="font-size:13px;">Check Metar-Taf.com ‚Üó</span>
                        </a>
                    </div>
                `;
                rawContainer.insertAdjacentHTML('beforeend', staleHtml);
            }

            // 4. Update Header Badge (Flight Rules)
            const rules = d.flight_rules; 
            let css = 'cat-vfr';
            if(rules==='MVFR') css='cat-mvfr'; 
            if(rules==='IFR') css='cat-ifr'; 
            if(rules==='LIFR') css='cat-lifr';
            
            // If stale, we keep the color but maybe add a marker? 
            // For now, we stick to the standard rules but the Big Red Box above handles the warning.
            updateHeaderCat(rules, css);

            // 5. Update Cards
            document.getElementById('mWind').innerText = `${currentWind.dir.toString().padStart(3,'0')}¬∞ / ${currentWind.spd}kt`;
            document.getElementById('mVis').innerText = d.visibility ? `${d.visibility.value} sm` : '--';
            const c = d.clouds?.[0]; 
            document.getElementById('mCeil').innerText = c ? `${c.type} ${c.altitude.toString().padStart(3,'0')}` : "CLR";
            
            const alt = d.altimeter?.value; 
            if(alt) {
                if(currentMetar.altUnit === 'hPa') { 
                    const inHg = (alt * 0.02953).toFixed(2); 
                    document.getElementById('mAlt').innerText = `Q${alt} / A${inHg}`; 
                } else { 
                    const hPa = Math.round(alt * 33.8639); 
                    document.getElementById('mAlt').innerText = `Q${hPa} / A${alt.toFixed(2)}`; 
                }
            }

            const t = d.temperature?.value, dew = d.dewpoint?.value;
            if(t!=null) {
                document.getElementById('mTempC').innerText = `${t}¬∞C / ${dew!=null?dew:'--'}¬∞C`;
                document.getElementById('mTempF').innerText = `(${Math.round(t*1.8+32)}¬∞F)`;
                document.getElementById('mSpread').innerText = `Spread: ${(t-dew).toFixed(1)}¬∞C`;
            }

            // 6. Update Age Footer
            const ageEl = document.getElementById('mAge');
            ageEl.innerText = `${minAgo}m ago`;
            // Turn the age text RED if old
            if (minAgo > 60) {
                ageEl.style.color = 'var(--danger)';
                ageEl.style.fontWeight = '700';
            } else {
                ageEl.style.color = 'var(--sub-text)';
                ageEl.style.fontWeight = '400';
            }
        }

        function renderInfo(d) {
            document.getElementById('infoName').innerText = d.name;
            document.getElementById('infoLoc').innerText = `${d.city || ''}, ${d.country || ''} (${d.icao})`;
            document.getElementById('infoCodes').innerText = `${d.icao} / ${d.iata || '--'}`;
            document.getElementById('infoElev').innerText = `${d.elevation_ft} ft`;
            document.getElementById('infoCoords').innerText = `${d.latitude.toFixed(4)}, ${d.longitude.toFixed(4)}`;

            // Calc Atmosphere
            const elev = d.elevation_ft; 
            const temp = currentMetar.temp;
            let currentHpa = currentMetar.alt;
            if(currentMetar.altUnit === 'inHg') currentHpa = currentMetar.alt * 33.8639;
            const pa = Math.round(elev + (1013.25 - currentHpa) * 30);
            const isaTemp = 15 - (2 * pa / 1000);
            const isaDev = Math.round(temp - isaTemp);
            const da = Math.round(pa + 120 * (temp - isaTemp));
            
            document.getElementById('calcPA').innerText = `${pa} ft`;
            document.getElementById('calcDA').innerText = `${da} ft`;
            document.getElementById('calcISA').innerText = `${isaDev >= 0 ? '+' : ''}${isaDev}¬∞C`;
            
            // Frequencies
            const fContainer = document.getElementById('freqContainer');
            fContainer.innerHTML = '';
            if(d.frequencies && d.frequencies.length > 0) {
                 d.frequencies.slice(0, 6).forEach(f => {
                     const card = document.createElement('div'); card.className = 'freq-card';
                     card.innerHTML = `<div class="freq-type">${f.type}</div><div class="freq-val">${f.frequency}</div>`;
                     fContainer.appendChild(card);
                 });
            }

            // Sun Times
            fetch(`https://api.sunrise-sunset.org/json?lat=${d.latitude}&lng=${d.longitude}&formatted=0`)
                .then(r=>r.json()).then(s => {
                    const t = (iso) => new Date(iso).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false});
                    document.getElementById('infoSun').innerText = `üåÖ ${t(s.results.sunrise)}  üåá ${t(s.results.sunset)}`;
                    stationSunTimes = { sunrise: new Date(s.results.sunrise), sunset: new Date(s.results.sunset) };
                    updateTafSkyGradient();
                }).catch(e=>{});
        }

        // --- WIND ROSE & RUNWAYS ---
        function setupRunwaySelect() {
            const sel = document.getElementById('rwySelect'); sel.innerHTML = '';
            const mv = stationData.magnetic_variation || 0;
            const windMag = currentWind.dir - mv;
            let bestRwy = null, maxHW = -999;
            (stationData.runways || []).forEach(r => {
                sel.add(new Option(`RWY ${r.ident1}`, r.ident1));
                sel.add(new Option(`RWY ${r.ident2}`, r.ident2));
                let h1 = parseInt(r.ident1.replace(/\D/g,'')) * 10;
                let hw1 = Math.cos((windMag - h1) * (Math.PI/180)) * currentWind.spd;
                if(hw1 > maxHW) { maxHW = hw1; bestRwy = r.ident1; }
            });
            if(bestRwy) sel.value = bestRwy; else if(stationData.runways.length > 0) sel.value = stationData.runways[0].ident1;
            drawWindRose(); 
            renderRunwaysComplex();
        }

        function drawWindRose() {
            const canvas = document.getElementById('windRose'); const ctx = canvas.getContext('2d'); const w=140, h=140, cx=70, cy=70, r=60;
            const rwyIdent = document.getElementById('rwySelect').value; 
            
            ctx.clearRect(0,0,w,h);
            ctx.beginPath(); ctx.arc(cx, cy, r, 0, 2*Math.PI); ctx.strokeStyle = '#555'; ctx.lineWidth = 2; ctx.stroke();
            ctx.fillStyle = '#8e8e93'; ctx.font = '10px sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText('N', cx, cy - r + 10); ctx.fillText('E', cx + r - 10, cy); ctx.fillText('S', cx, cy + r - 10); ctx.fillText('W', cx - r + 10, cy);
            
            const mv = stationData?.magnetic_variation || 0; 
            const windMag = currentWind.dir - mv;
            
            if(rwyIdent) {
                const rwyHdg = parseInt(rwyIdent.replace(/\D/g,'')) * 10; const rwyRad = (rwyHdg - 90) * (Math.PI/180);
                ctx.save(); ctx.translate(cx, cy); ctx.rotate(rwyRad); 
                ctx.fillStyle = '#333'; ctx.fillRect(-r+15, -6, (r*2)-30, 12); 
                ctx.strokeStyle = '#fff'; ctx.lineWidth = 1; ctx.strokeRect(-r+15, -6, (r*2)-30, 12); 
                ctx.restore();
                
                const diff = (windMag - rwyHdg) * (Math.PI/180); 
                const hw = Math.round(Math.cos(diff) * currentWind.spd); 
                const xw = Math.round(Math.sin(diff) * currentWind.spd);
                
                const vHW = document.getElementById('valHW'); 
                vHW.innerText = hw >= 0 ? `${hw}kt Head` : `${Math.abs(hw)}kt Tail`; 
                vHW.style.color = hw < 0 ? 'var(--danger)' : 'var(--success)';
                document.getElementById('valXW').innerText = `${Math.abs(xw)}kt ${xw >= 0 ? 'L' : 'R'}`;
                
                checkMins();
            }
            if(currentWind.spd > 0) {
                const windRad = (windMag - 90) * (Math.PI/180); 
                ctx.save(); ctx.translate(cx, cy); ctx.rotate(windRad);
                ctx.beginPath(); ctx.moveTo(r-5, 0); ctx.lineTo(10, 0); ctx.strokeStyle = '#0a84ff'; ctx.lineWidth = 3; ctx.stroke();
                ctx.beginPath(); ctx.moveTo(15, -5); ctx.lineTo(5, 0); ctx.lineTo(15, 5); ctx.fillStyle = '#0a84ff'; ctx.fill(); ctx.restore();
            }
        }

        function renderRunwaysComplex() {
            const container = document.getElementById('runwayListComplex'); container.innerHTML = '';
            const d = stationData; if(!d || !d.runways) return;
            const magVar = d.magnetic_variation || 0;
            const windMagDir = currentWind.dir - magVar;
            
            d.runways.forEach((r, idx) => {
                let dimStr = useMetric ? `${Math.round(r.length_ft * 0.3048)}m` : `${r.length_ft}'`;
                const rwy1Hdg = parseInt(r.ident1.replace(/\D/g,'')) * 10;
                const diffRad = (windMagDir - rwy1Hdg) * (Math.PI/180);
                const hw = Math.round(Math.cos(diffRad) * currentWind.spd); 
                const xw = Math.round(Math.sin(diffRad) * currentWind.spd);
                const color1 = hw >= 0 ? 'var(--success)' : 'var(--danger)';
                const color2 = hw < 0 ? 'var(--success)' : 'var(--danger)';
                
                const div = document.createElement('div');
                div.className = 'rwy-complex';
                div.innerHTML = `
                    <div class="rc-header"><div class="rc-idents"><span style="color:${color1}">${r.ident1}</span> / <span style="color:${color2}">${r.ident2}</span></div><div class="rc-dims">${dimStr}</div></div>
                    <div class="rc-strip">
                        <div class="rc-id-v">${r.ident1}</div>
                        <div class="rc-data">
                            <div class="wind-comp"><span>${Math.abs(hw)}kt</span><span style="color:${color1}">${hw>=0?'‚¨Ü':'‚¨á'}</span></div>
                            <div class="wind-comp"><span>${Math.abs(xw)}kt</span><span style="color:#0a84ff">${xw>=0?'‚¨Ö':'‚û°'}</span></div>
                        </div>
                        <div class="rc-id-v" style="transform:rotate(0deg);">${r.ident2}</div>
                    </div>`;
                container.appendChild(div);
            });
        }

        // --- TAF RENDERER ---
        function renderTaf(d) {
            document.getElementById('rawTaf').innerText = d.raw || "No TAF Data";
            tafDataCache = d.forecast; 
            const bar = document.getElementById('tafBar'); 
            const axis = document.getElementById('tafAxis'); 
            bar.innerHTML = ''; axis.innerHTML = '';
            document.getElementById('tafDetail').classList.add('hidden');
            
            if(!d.forecast || d.forecast.length === 0) return;
            
            // Timeline Logic
            const startT = new Date(d.forecast[0].start_time.dt);
            const endT = new Date(d.forecast[d.forecast.length-1].end_time.dt);
            const totalDur = endT - startT; 
            const now = new Date();

            // Needle
            if (now >= startT && now <= endT) {
                const p = ((now - startT) / totalDur) * 100;
                const needle = document.getElementById('tafNeedle');
                needle.style.display = 'block'; needle.style.left = `${p}%`;
            }

            d.forecast.forEach((f, index) => {
                const block = document.createElement('div'); 
                block.className = 'taf-block'; block.style.flex = "1";
                let col = '#555'; 
                if(f.flight_rules==='VFR')col='var(--success)'; 
                if(f.flight_rules==='MVFR')col='var(--mvfr)'; 
                if(f.flight_rules==='IFR')col='var(--danger)';
                block.style.backgroundColor = col; block.innerText = f.type;
                block.onclick = () => { showTafDetail(index, col); };
                bar.appendChild(block);
                
                if(index % 2 === 0) {
                    const s = new Date(f.start_time.dt); 
                    const lbl = document.createElement('div'); 
                    lbl.className = 'taf-axis-lbl'; lbl.style.flex = "2";
                    lbl.innerText = `${s.getUTCHours()}z`; 
                    axis.appendChild(lbl);
                }
            });
            updateTafSkyGradient(startT, endT);
        }

        function showTafDetail(index, color) {
            const f = tafDataCache[index]; 
            const card = document.getElementById('tafDetail'); 
            card.style.borderLeftColor = color; card.classList.remove('hidden');
            
            const s = new Date(f.start_time.dt); const e = new Date(f.end_time.dt);
            document.getElementById('tdTime').innerText = `${s.getUTCHours()}z ‚ûî ${e.getUTCHours()}z`; 
            document.getElementById('tdType').innerText = f.type;
            
            const wDir = f.wind_direction?.value || 'VRB'; 
            document.getElementById('tdWind').innerText = `${wDir}¬∞ / ${f.wind_speed?.value||0}kt`;
            document.getElementById('tdVis').innerText = f.visibility ? `${f.visibility.value} sm` : 'P6SM';
            document.getElementById('tdWx').innerText = f.wx_codes ? f.wx_codes.map(x => x.repr).join(' ') : 'NSW';
            
            let cStr = 'SKC'; 
            if(f.clouds && f.clouds.length > 0) cStr = f.clouds.map(c => `${c.type}${c.altitude.toString().padStart(3,'0')}`).join(' '); 
            document.getElementById('tdCloud').innerText = cStr;
        }

        function updateTafSkyGradient(startT, endT) {
            if(!stationSunTimes || !startT || !endT) return;
            // Simple visual approximation of Day/Night cycle
            const cNight = "#0f172a"; const cDay = "#0ea5e9"; const cDawn = "#f97316";
            let css = `linear-gradient(to right, ${cNight} 0%, ${cDawn} 20%, ${cDay} 30%, ${cDay} 70%, ${cDawn} 80%, ${cNight} 100%)`;
            document.getElementById('tafSkyStrip').style.background = css;
        }

        // --- WORLD CLOCK ---
        function initWorldClock() {
            const stored = localStorage.getItem('efb_cities_v46');
            if(stored) cityList = JSON.parse(stored);
            else cityList = [...AVIATION_CITIES];
        }
        function updateClock() {
            const now = new Date();
            document.getElementById('zuluTime').innerText = `${now.getUTCHours().toString().padStart(2,'0')}:${now.getUTCMinutes().toString().padStart(2,'0')}Z`;
            
            if(document.getElementById('tab-world').classList.contains('active')) {
                const container = document.getElementById('worldContainer'); container.innerHTML = '';
                cityList.forEach(c => {
                    const timeStr = now.toLocaleTimeString('en-US', { timeZone: c.z, hour: '2-digit', minute: '2-digit', hour12: false });
                    const card = document.createElement('div'); card.className = 'clock-card';
                    card.innerHTML = `
                        <div class="clock-left"><div><span class="clock-city">${c.n}</span><span style="color:var(--accent); font-weight:700; margin-left:8px;">${c.icao||''}</span></div></div>
                        <div class="clock-time">${timeStr}</div>`;
                    container.appendChild(card);
                });
            }
        }
        async function addCustomCity() {
            const val = document.getElementById('newCityInput').value;
            if(!val) return;
            cityList.push({n:val, z:'UTC', icao:'USER'}); // Simplified logic for demo
            localStorage.setItem('efb_cities_v46', JSON.stringify(cityList));
            updateClock();
        }

        // --- E6B & MINS ---
        function checkMins() {
            if (!currentMetar || !stationData) { document.getElementById('minsResult').innerText = "LOAD DATA"; return; }
            const limitXW = parseFloat(document.getElementById('minXW').value) || 0;
            const limitCeil = parseFloat(document.getElementById('minCeil').value) || 0;
            const rwyIdent = document.getElementById('rwySelect').value; 
            
            let actualXW = 0;
            if (rwyIdent) {
                const mv = stationData.magnetic_variation || 0;
                const rwyHdg = parseInt(rwyIdent.replace(/\D/g,'')) * 10;
                const diff = (currentWind.dir - mv - rwyHdg) * (Math.PI/180);
                actualXW = Math.abs(Math.sin(diff) * currentWind.spd);
            }
            
            let actualCeil = 9999;
            if (lastMetarObj && lastMetarObj.clouds) {
                const ceilLayer = lastMetarObj.clouds.find(c => c.type === 'BKN' || c.type === 'OVC');
                if (ceilLayer) actualCeil = ceilLayer.altitude * 100;
            }

            const resDiv = document.getElementById('minsResult');
            const card = document.getElementById('minsCard');
            
            if (actualXW > limitXW || actualCeil < limitCeil) {
                resDiv.innerText = "NO-GO ‚õî"; resDiv.style.backgroundColor = "var(--danger)"; resDiv.style.color = "#fff"; card.style.borderLeftColor = "var(--danger)";
            } else {
                resDiv.innerText = "GO ‚úÖ"; resDiv.style.backgroundColor = "var(--success)"; resDiv.style.color = "#000"; card.style.borderLeftColor = "var(--success)";
            }
        }

        function calcE6B() {
            const alt = parseFloat(document.getElementById('e6bAlt').value) || 0;
            const qnh = parseFloat(document.getElementById('e6bQnh').value) || 1013;
            const temp = parseFloat(document.getElementById('e6bTemp').value) || 15;
            const ias = parseFloat(document.getElementById('e6bIas').value) || 0;
            
            const pa = alt + (1013 - qnh) * 30;
            const da = pa + 120 * (temp - (15 - (2*pa/1000)));
            document.getElementById('resDA').innerText = Math.round(da) + " ft";
            
            // Simplified TAS
            const tas = ias * (1 + (alt/1000 * 0.02)); 
            document.getElementById('resTAS').innerText = Math.round(tas) + " kts";
        }

        // --- UTILS ---
        
        // --- NEW: SMART FORMATTER ---
        function formatRawMetar(rawText) {
            if (!rawText) return "";
            let html = rawText;
            // 1. Gusts (e.g. G25KT) - Red
            html = html.replace(/(G\d{2,3}KT)/g, '<span style="color:var(--danger); font-weight:800;">$1</span>');
            // 2. Low Vis (e.g. 1/2SM) - Purple
            html = html.replace(/(\s)(M?(\d\/\d|[0-2]))(SM)/g, '$1<span style="color:var(--lifr); font-weight:800;">$2$4</span>');
            // 3. Low Ceiling/VV - Red
            html = html.replace(/(VV\d{3}|OVC00[0-4])/g, '<span style="color:var(--danger); font-weight:800;">$1</span>');
            // 4. TS/Heavy Precip - Orange
            html = html.replace(/(\s)(\+?\w*TS\w*|\+RA|\+SN|SQ|FC)(\s|$)/g, '$1<span style="color:var(--warn); font-weight:800;">$2</span>$3');
            return html;
        }

        function setTab(name) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-'+name).classList.add('active');
            event.target.classList.add('active');
            if(name === 'world') updateClock();
        }
        function updateHeaderCat(status, colorClass) {
            const badge = document.getElementById('headerCat');
            badge.innerText = status; badge.className = 'badge badge-cat ' + colorClass;
        }
        function toggleClearBtn() {
            const val = document.getElementById('icao').value;
            document.getElementById('clearBtn').style.display = val ? 'block' : 'none';
        }
        function clearSearch() { document.getElementById('icao').value = ''; document.getElementById('icao').focus(); toggleClearBtn(); }

        // Start
        initApp();
    </script>
</body>
</html>

